# ุถุจุท ุฏููู ููููุฐุฌ ุจุงุณุชุฎุฏุงู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช Trainer

๐ค ูููุฑ Transformers ูุฆุฉ `Trainer` ูููุณุงุนุฏุฉ ูู ุถุจุท ุฏููู ูุฃู ูู ุงูููุงุฐุฌ ุงูููุฏุฑุจุฉ ูุณุจููุง ุงูุชู ูููุฑูุง ุนูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจู. ุจูุฌุฑุฏ ุงูุงูุชูุงุก ูู ุฌููุน ุฃุนูุงู ุงููุนุงูุฌุฉ ุงููุณุจูุฉ ููุจูุงูุงุช ูู ุงููุณู ุงูุฃุฎูุฑุ ูู ูุชุจู ุณูู ุจุถุน ุฎุทูุงุช ูุชุญุฏูุฏ ูุฆุฉ `Trainer`. ูู ุงููุญุชูู ุฃู ูููู ุงูุฌุฒุก ุงูุฃุตุนุจ ูู ุฅุนุฏุงุฏ ุงูุจูุฆุฉ ูุชุดุบูู `Trainer.train()`ุ ุญูุซ ุณูุนูู ุจุจุทุก ุดุฏูุฏ ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ. ุฅุฐุง ูู ููู ูุฏูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณูููุฉ (GPU) ุฌุงูุฒุฉุ ูููููู ุงููุตูู ุฅูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ (GPUs) ุฃู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฏูุฉ ุงููุงุฆูุฉ (TPUs) ูุฌุงููุง ุนูู [Google Colab](https://colab.research.google.com/).

ุชูุชุฑุถ ุฃูุซูุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุฃุฏูุงู ุฃูู ูุฏ ููุฐุช ุจุงููุนู ุงูุฃูุซูุฉ ูู ุงููุณู ุงูุณุงุจู. ูููุง ููู ููุฎุต ูุตูุฑ ูุณุชุนุฑุถ ูุง ุชุญุชุงุฌ ุฅููู:

```py
from datasets import load_dataset
from transformers import AutoTokenizer, DataCollatorWithPadding

raw_datasets = load_dataset("glue", "mrpc")
checkpoint = "bert-base-uncased"
tokenizer = AutoTokenizer.from_pretrained(checkpoint)


def tokenize_function(example):
    return tokenizer(example["sentence1"], example["sentence2"], truncation=True)


tokenized_datasets = raw_datasets.map(tokenize_function, batched=True)
data_collator = DataCollatorWithPadding(tokenizer=tokenizer)
```

## ุงูุชุฏุฑูุจ

ุงูุฎุทูุฉ ุงูุฃููู ูุจู ุฃู ูุชููู ูู ุชุญุฏูุฏ ูุฆุฉ `Trainer` ุงูุฎุงุตุฉ ุจูุง ูู ุชุญุฏูุฏ ูุฆุฉ `TrainingArguments` ุงูุชู ุณุชุชุถูู ุฌููุน ูุฑุท ุงููุนููุงุช ุงูุชู ุณุชุณุชุฎุฏููุง ูุฆุฉ `Trainer` ููุชุฏุฑูุจ ูุงูุชูููู. ุงูุญุฌุฉ ุงููุญูุฏุฉ ุงูุชู ูุฌุจ ุชูููุฑูุง ูู ุฏููู ุญูุซ ุณูุชู ุญูุธ ุงููููุฐุฌ ุงููุฏุฑุจุ ุจุงูุฅุถุงูุฉ ุฅูู ููุงุท ุงููุฑุงูุจุฉ ุนูู ุทูู ุงูุทุฑูู. ุจุงููุณุจุฉ ููู ุดูุก ุขุฎุฑุ ููููู ุชุฑู ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉุ ูุงูุชู ูุฌุจ ุฃู ุชุนูู ุจุดูู ุฌูุฏ ุฌุฏูุง ููุถุจุท ุงูุฏููู ุงูุฃุณุงุณู.

```py
from transformers import TrainingArguments

training_args = TrainingArguments("test-trainer")
```

<Tip>

๐ก ุฅุฐุง ููุช ุชุฑูุฏ ุชุญููู ูููุฐุฌู ุชููุงุฆููุง ุฅูู Hub ุฃุซูุงุก ุงูุชุฏุฑูุจุ ููุฑุฑ `push_to_hub=True` ูู `TrainingArguments`. ุณูุชุนูู ุงููุฒูุฏ ุนู ูุฐุง ูู [ุงููุตู 4](/course/chapter4/3).

</Tip>

ุงูุฎุทูุฉ ุงูุซุงููุฉ ูู ุชุญุฏูุฏ ูููุฐุฌูุง. ููุง ูู ุงูุญุงู ูู [ุงููุตู ุงูุณุงุจู](/course/chapter2)ุ ุณูุณุชุฎุฏู ูุฆุฉ `AutoModelForSequenceClassification`ุ ูุน ุนูุงูุชูู:

```py
from transformers import AutoModelForSequenceClassification

model = AutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)
```

ุณุชูุงุญุธ ุฃูู ุนูู ุนูุณ [ุงููุตู 2](/course/chapter2)ุ ุชุญุตู ุนูู ุชุญุฐูุฑ ุจุนุฏ ุฅูุดุงุก ูุฐุง ุงููููุฐุฌ ุงูููุฏุฑุจ ูุณุจููุง. ููุฑุฌุน ุฐูู ุฅูู ุฃู BERT ูู ูุชู ุชุฏุฑูุจู ูุณุจููุง ุนูู ุชุตููู ุฃุฒูุงุฌ ุงูุฌููุ ูุฐูู ุชู ุงูุชุฎูุต ูู ุฑุฃุณ ุงููููุฐุฌ ุงูููุฏุฑุจ ูุณุจููุง ูุชูุช ุฅุถุงูุฉ ุฑุฃุณ ุฌุฏูุฏ ููุงุณุจ ูุชุตููู ุงูุชุณูุณู ุจุฏูุงู ูู ุฐูู. ุชุดูุฑ ุงูุชุญุฐูุฑุงุช ุฅูู ุฃู ุจุนุถ ุงูุฃูุฒุงู ูู ูุชู ุงุณุชุฎุฏุงููุง (ุงูุชู ุชุชูุงูู ูุน ุฑุฃุณ ุงูุชุฏุฑูุจ ุงููุณุจู ุงูููุณูุท) ูุฃู ุงูุจุนุถ ุงูุขุฎุฑ ุชู ุชููุฆุชู ุจุดูู ุนุดูุงุฆู (ุงูุฎุงุต ุจุงูุฑุฃุณ ุงูุฌุฏูุฏ). ููุฎุชุชู ุจุชุดุฌูุนู ุนูู ุชุฏุฑูุจ ุงููููุฐุฌุ ููู ูุง ุณูููู ุจู ุงูุขู ุจุงูุถุจุท.

ุจูุฌุฑุฏ ุญุตูููุง ุนูู ูููุฐุฌูุงุ ูููููุง ุชุญุฏูุฏ ูุฆุฉ `Trainer` ุนู ุทุฑูู ุชูุฑูุฑ ุฌููุน ุงููุงุฆูุงุช ุงูุชู ุชู ุฅูุดุงุคูุง ุญุชู ุงูุขู - `model`ุ ู`training_args`ุ ููุฌููุนุงุช ุงูุจูุงูุงุช ููุชุฏุฑูุจ ูุงูุชุญูู ูู ุงูุตุญุฉุ ู`data_collator`ุ ู`tokenizer`:

```py
from transformers import Trainer

trainer = Trainer(
    model,
    training_args,
    train_dataset=tokenized_datasets["train"],
    eval_dataset=tokenized_datasets["validation"],
    data_collator=data_collator,
    tokenizer=tokenizer,
)
```

ูุงุญุธ ุฃูู ุนูุฏ ุชูุฑูุฑ `tokenizer` ููุง ูุนููุง ููุงุ ูุฅู ูุฆุฉ `data_collator` ุงูุงูุชุฑุงุถูุฉ ุงูุชู ูุณุชุฎุฏููุง `Trainer` ุณุชููู `DataCollatorWithPadding` ููุง ูู ูุญุฏุฏ ุณุงุจููุงุ ูุฐุง ููููู ุชุฎุทู ุงูุณุทุฑ `data_collator=data_collator` ูู ูุฐู ุงูููุงููุฉ. ูุงู ูู ุงูููู ูุน ุฐูู ุฃู ูุทูุนู ุนูู ูุฐุง ุงูุฌุฒุก ูู ุงููุนุงูุฌุฉ ูู ุงููุณู 2!

ูุถุจุท ุงููููุฐุฌ ุงูุฏููู ุนูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจูุงุ ูุง ุนูููุง ุณูู ุงุณุชุฏุนุงุก ุทุฑููุฉ `train()` ูู ูุฆุฉ `Trainer`:

```py
trainer.train()
```

ุณูุจุฏุฃ ูุฐุง ุงูุถุจุท ุงูุฏููู (ุงูุฐู ูุฌุจ ุฃู ูุณุชุบุฑู ุจุถุน ุฏูุงุฆู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณูููุฉ) ููุจูุบ ุนู ุฎุณุงุฑุฉ ุงูุชุฏุฑูุจ ูู 500 ุฎุทูุฉ. ููุน ุฐููุ ููู ูุฎุจุฑู ุจูุฏู ุฌูุฏุฉ (ุฃู ุณูุก) ุฃุฏุงุก ูููุฐุฌู. ููุฑุฌุน ุฐูู ุฅูู ูุง ููู:

1. ูู ูุฎุจุฑ ูุฆุฉ `Trainer` ุจุฅุฌุฑุงุก ุงูุชูููู ุฃุซูุงุก ุงูุชุฏุฑูุจ ุนู ุทุฑูู ุชุนููู `evaluation_strategy` ุฅูุง `"steps"` (ุชูููู ูู `eval_steps`) ุฃู `"epoch"` (ุชูููู ูู ููุงูุฉ ูู ูุชุฑุฉ).
2. ูู ููุฏู ูู `Trainer` ุฏุงูุฉ `compute_metrics()` ูุญุณุงุจ ูููุงุณ ุฃุซูุงุก ุงูุชูููู ุงููุฐููุฑ (ูุฅูุง ูุฅู ุงูุชูููู ูุงู ุณููุทุจุน ุจุจุณุงุทุฉ ุงูุฎุณุงุฑุฉุ ููู ุฑูู ุบูุฑ ุจุฏููู).

## ุงูุชูููู

ุฏุนููุง ูุฑู ููู ูููููุง ุจูุงุก ุฏุงูุฉ `compute_metrics()` ูููุฏุฉ ูุงุณุชุฎุฏุงููุง ูู ุงููุฑุฉ ุงููุงุฏูุฉ ุงูุชู ูููู ูููุง ุจุงูุชุฏุฑูุจ. ูุฌุจ ุฃู ุชุฃุฎุฐ ุงูุฏุงูุฉ ูุงุฆู `EvalPrediction` (ููู ุนุจุงุฑุฉ ุนู ูุฌููุนุฉ ูุณูุงุฉ ูุน ุญูู `predictions` ูุญูู `label_ids`) ูุณุชุนูุฏ ูุงููุณูุง ูุฑุณู ุงูุณูุงุณู ุฅูู ุฃุฑูุงู ุงููุงุตูุฉ ุงูุนุงุฆูุฉ (ุงูุฃุญุฑู ุงูุณูุณูุฉ ูู ุฃุณูุงุก ุงูููุงููุณ ุงููุนุงุฏุฉุ ูุฃุฑูุงู ุงููุงุตูุฉ ุงูุนุงุฆูุฉ ูู ููููุง). ููุญุตูู ุนูู ุจุนุถ ุงูุชููุนุงุช ูู ูููุฐุฌูุงุ ูููููุง ุงุณุชุฎุฏุงู ุฃูุฑ `Trainer.predict()`:

```py
predictions = trainer.predict(tokenized_datasets["validation"])
print(predictions.predictions.shape, predictions.label_ids.shape)
```

```python out
(408, 2) (408,)
```

ุงููุงุชุฌ ูู ุทุฑููุฉ `predict()` ูู ูุฌููุนุฉ ูุณูุงุฉ ุฃุฎุฑู ูุน ุซูุงุซุฉ ุญููู: `predictions`ุ ู`label_ids`ุ ู`metrics`. ุณูุญุชูู ุญูู `metrics` ููุท ุนูู ุงูุฎุณุงุฑุฉ ูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุชูุฑูุฑูุงุ ุจุงูุฅุถุงูุฉ ุฅูู ุจุนุถ ุงูููุงููุณ ุงูุฒูููุฉ (ูุฏุฉ ุงูููุช ุงููุณุชุบุฑู ููุชูุจุคุ ูู ุงููุฌููุน ููุชูุณุท). ุจูุฌุฑุฏ ุงูุชูุงู ุฏุงูุฉ `compute_metrics()` ุงูุฎุงุตุฉ ุจูุง ูุชูุฑูุฑูุง ุฅูู ูุฆุฉ `Trainer`ุ ุณูุญุชูู ูุฐุง ุงูุญูู ุฃูุถูุง ุนูู ุงูููุงููุณ ุงูุชู ุชุนูุฏูุง `compute_metrics()`.

ููุง ุชุฑููุ ูุฅู `predictions` ุนุจุงุฑุฉ ุนู ูุตูููุฉ ุซูุงุฆูุฉ ุงูุฃุจุนุงุฏ ุจุญุฌู 408 ร 2 (408 ูู ุนุฏุฏ ุงูุนูุงุตุฑ ูู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุชู ุงุณุชุฎุฏููุงูุง). ูุฐู ูู ุงูููู ุงูุงุญุชูุงููุฉ ููู ุนูุตุฑ ูู ุนูุงุตุฑ ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุชูุฑูุฑูุง ุฅูู `predict()` (ููุง ุฑุฃูุช ูู [ุงููุตู ุงูุณุงุจู](/course/chapter2)ุ ุชุนูุฏ ุฌููุน ููุงุฐุฌ Transformer ุงูููู ุงูุงุญุชูุงููุฉ). ูุชุญููููุง ุฅูู ุชูุจุคุงุช ูููููุง ููุงุฑูุชูุง ุจุนูุงูุงุชูุงุ ูุญุชุงุฌ ุฅูู ุฃุฎุฐ ุงูููุฑุณ ุจุงููููุฉ ุงููุตูู ุนูู ุงููุญูุฑ ุงูุซุงูู:

```py
import numpy as np

preds = np.argmax(predictions.predictions, axis=-1)
```

ุงูุขู ูููููุง ููุงุฑูุฉ ุชูู `preds` ุจุงูุนูุงูุงุช. ูุจูุงุก ุฏุงูุฉ `compute_metric()` ุงูุฎุงุตุฉ ุจูุงุ ุณูุนุชูุฏ ุนูู ุงูููุงููุณ ูู ููุชุจุฉ ๐ค [Evaluate](https://github.com/huggingface/evaluate/). ูููููุง ุชุญููู ุงูููุงููุณ ุงููุฑุชุจุทุฉ ุจูุฌููุนุฉ ุจูุงูุงุช MRPC ุจุณูููุฉ ููุง ุญููููุง ูุฌููุนุฉ ุงูุจูุงูุงุชุ ููุฐู ุงููุฑุฉ ุจุงุณุชุฎุฏุงู ุฏุงูุฉ `evaluate.load()`. ูุญุชูู ุงููุงุฆู ุงูุฐู ุชูุช ุฅุนุงุฏุชู ุนูู ุทุฑููุฉ `compute()` ุงูุชู ูููููุง ุงุณุชุฎุฏุงููุง ูุญุณุงุจ ุงูููุงุณ:

```py
import evaluate

metric = evaluate.load("glue", "mrpc")
metric.compute(predictions=preds, references=predictions.label_ids)
```

```python out
{'accuracy': 0.8578431372549019, 'f1': 0.8996539792387542}
```

ูุฏ ุชุฎุชูู ุงููุชุงุฆุฌ ุงูุฏูููุฉ ุงูุชู ุชุญุตู ุนูููุงุ ุญูุซ ูุฏ ูุคุฏู ุงูุชููุฆุฉ ุงูุนุดูุงุฆู ูุฑุฃุณ ุงููููุฐุฌ ุฅูู ุชุบููุฑ ุงูููุงููุณ ุงูุชู ุญูููุง. ููุงุ ูููููุง ุฃู ูุฑู ุฃู ูููุฐุฌูุง ูุฏูู ุฏูุฉ 85.78% ุนูู ูุฌููุนุฉ ุงูุชุญูู ูู ุงูุตุญุฉ ููููุงุณ F1 ูู 89.97. ูุฐุงู ููุง ุงููููุงุณุงู ุงููุณุชุฎุฏูุงู ูุชูููู ุงููุชุงุฆุฌ ุนูู ูุฌููุนุฉ ุจูุงูุงุช MRPC ููููุงุณ GLUE. ูุนุฑุถ ุงูุฌุฏูู ูู [ูุฑูุฉ BERT](https://arxiv.org/pdf/1810.04805.pdf) ุฏุฑุฌุฉ F1 ูู 88.9 ูููููุฐุฌ ุงูุฃุณุงุณู. ูุงู ูุฐุง ูู ุงููููุฐุฌ "ุบูุฑ ุงููููููุฒ" ุจูููุง ูุณุชุฎุฏู ุญุงูููุง ุงููููุฐุฌ "ุงููููููุฒ"ุ ูุงูุฐู ููุณุฑ ุงููุชูุฌุฉ ุงูุฃูุถู.

ูุฅูููู ุฏุงูุฉ `compute_metrics()` ูุฌูุนุฉ:

```py
def compute_metrics(eval_preds):
    metric = evaluate.load("glue", "mrpc")
    logits, labels = eval_preds
    predictions = np.argmax(logits, axis=-1)
    return metric.compute(predictions=predictions, references=labels)
```

ููุฑุคูุชูุง ูุณุชุฎุฏูุฉ ูู ุงูุฅุจูุงุบ ุนู ุงูููุงููุณ ูู ููุงูุฉ ูู ูุชุฑุฉุ ุฅููู ููููุฉ ุชุญุฏูุฏ ูุฆุฉ `Trainer` ุฌุฏูุฏุฉ ูุน ุฏุงูุฉ `compute_metrics()` ูุฐู:

```py
training_args = TrainingArguments("test-trainer", evaluation_strategy="epoch")
model = AutoModelForSequenceClassification.from_pretrained(checkpoint, num_labels=2)

trainer = Trainer(
    model,
    training_args,
    train_dataset=tokenized_datasets["train"],
    eval_dataset=tokenized_datasets["validation"],
    data_collator=data_collator,
    tokenizer=tokenizer,
    compute_metrics=compute_metrics,
)
```

ูุงุญุธ ุฃููุง ุฃูุดุฃูุง ูุฆุฉ `TrainingArguments` ุฌุฏูุฏุฉ ูุน `evaluation_strategy` ุงูุฎุงุตุฉ ุจูุง ูุงูุชู ุชู ุชุนููููุง ุฅูู `"epoch"` ููููุฐุฌ ุฌุฏูุฏ - ูุฅูุง ูุฅููุง ุณูุณุชูุฑ ููุท ูู ุชุฏุฑูุจ ุงููููุฐุฌ ุงูุฐู ูููุง ุจุชุฏุฑูุจู ุจุงููุนู. ูุจุฏุก ุชุดุบูู ุงูุชุฏุฑูุจ ุงูุฌุฏูุฏุ ูููุฐ ูุง ููู:

```py
trainer.train()
```

ูุฐู ุงููุฑุฉุ ุณูุจูุบ ุนู ุฎุณุงุฑุฉ ุงูุชุญูู ูู ุงูุตุญุฉ ูุงูููุงููุณ ูู ููุงูุฉ ูู ูุชุฑุฉ ุจุงูุฅุถุงูุฉ ุฅูู ุฎุณุงุฑุฉ ุงูุชุฏุฑูุจ. ูุฑุฉ ุฃุฎุฑูุ ูุฏ ุชุฎุชูู ุฏูุฉ F1/ุงูุฏูุฉ ุงูุฏูููุฉ ุงูุชู ุชุตู ุฅูููุง ููููุงู ุนูุง ูุฌุฏูุงูุ ุจุณุจุจ ุงูุชููุฆุฉ ุงูุนุดูุงุฆูุฉ ูุฑุฃุณ ุงููููุฐุฌุ ูููู ูุฌุจ ุฃู ุชููู ูู ููุณ ุงููุทุงู.

ุณุชุนูู ูุฆุฉ `Trainer` ุฎุงุฑุฌ ุงูุตูุฏูู ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณูููุฉ ุฃู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฏูุฉ ุงููุงุฆูุฉ ูุชุนุฏุฏุฉุ ูุชููุฑ ุงููุซูุฑ ูู ุงูุฎูุงุฑุงุชุ ูุซู ุงูุชุฏุฑูุจ ุนูู ุงูุฏูุฉ ุงููุงุฆูุฉ ุงููุฎุชูุทุฉ (ุงุณุชุฎุฏู `fp16 = True` ูู ุญุฌุฌ ุงูุชุฏุฑูุจ ุงูุฎุงุตุฉ ุจู). ุณูุชูุงูู ูู ูุง ูุฏุนูู ูู ุงููุตู 10.

ููุฐุง ูุฎุชุชู ุงูููุฏูุฉ ูุถุจุท ุฏููู ุจุงุณุชุฎุฏุงู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช `Trainer`. ุณูุชู ุชูุฏูู ูุซุงู ุนูู ุงูููุงู ุจุฐูู ููุนุธู ููุงู NLP ุงูุดุงุฆุนุฉ ูู [ุงููุตู 7](/course/chapter7)ุ ูููู ุงูุขู ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ููููุฉ ุงูููุงู ุจููุณ ุงูุดูุก ูู PyTorch ุงูููู.

<Tip>

โ๏ธ **ุฌุฑูุจูุง!** ูู ุจุถุจุท ูููุฐุฌ ุจุฏูุฉ ุนูู ูุฌููุนุฉ ุจูุงูุงุช GLUE SST-2ุ ุจุงุณุชุฎุฏุงู ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงูุชู ููุช ุจูุง ูู ุงููุณู 2.

</Tip>