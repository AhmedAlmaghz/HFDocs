# ุงูููุงุฐุฌ ุงููุฎุตุตุฉ

ุชุนุฏ ุจุนุถ ุชูููุงุช ุงูุถุจุท ุงูุฏูููุ ูุซู ุถุจุท ุงูููุงุตูุ ุฎุงุตุฉ ุจููุงุฐุฌ ุงููุบุฉ. ููุฐุง ูุนูู ุฃูู ูู ๐ค PEFTุ ูู ุงูููุชุฑุถ ุงุณุชุฎุฏุงู ูููุฐุฌ ๐ค Transformers. ููุน ุฐููุ ูุง ุชูุชุตุฑ ุชูููุงุช ุงูุถุจุท ุงูุฏููู ุงูุฃุฎุฑู - ูุซู [LoRA](../conceptual_guides/lora) - ุนูู ุฃููุงุน ููุงุฐุฌ ูุญุฏุฏุฉ.

ูู ูุฐุง ุงูุฏูููุ ุณูุฑู ููู ูููู ุชุทุจูู LoRA ุนูู ุดุจูุฉ ุนุตุจูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุชุ ููููุฐุฌ ุฑุคูุฉ ุญุงุณูุจูุฉ ูู ููุชุจุฉ [timm](https://huggingface.co/docs/timm/index)ุ ุฃู ุจููุฉ ุฌุฏูุฏุฉ ูู ๐ค Transformers.

## ุงูุดุจูุฉ ุงูุนุตุจูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช

ูููุชุฑุถ ุฃููุง ูุฑูุฏ ุถุจุท ุดุจูุฉ ุนุตุจูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช ุจุงุณุชุฎุฏุงู LoRA. ูููุง ููู ุงูุชุนุฑูู:

```python
from torch import nn


class MLP(nn.Module):
    def __init__(self, num_units_hidden=2000):
        super().__init__()
        self.seq = nn.Sequential(
            nn.Linear(20, num_units_hidden),
            nn.ReLU(),
            nn.Linear(num_units_hidden, num_units_hidden),
            nn.ReLU(),
            nn.Linear(num_units_hidden, 2),
            nn.LogSoftmax(dim=-1),
        )

    def forward(self, X):
        return self.seq(X)
```

ูุฐู ุดุจูุฉ ุนุตุจูุฉ ูุชุนุฏุฏุฉ ุงูุทุจูุงุช ูุจุงุดุฑุฉ ูุน ุทุจูุฉ ุฏุฎู ูุทุจูุฉ ูุฎููุฉ ูุทุจูุฉ ุฅุฎุฑุงุฌ.

<Tip>

ุจุงููุณุจุฉ ููุฐุง ุงููุซุงู ุงูุชูุถูุญูุ ูุฎุชุงุฑ ุนุฏุฏูุง ูุจูุฑูุง ุฌุฏูุง ูู ุงููุญุฏุงุช ุงููุฎููุฉ ูุฅุจุฑุงุฒ ููุงุณุจ ุงูููุงุกุฉ ูู PEFTุ ูููู ูุฐู ุงูููุงุณุจ ุชุชูุงุดู ูุน ุงูุฃูุซูุฉ ุงูุฃูุซุฑ ูุงูุนูุฉ.

</Tip>

ููุงู ุจุถุน ุทุจูุงุช ุฎุทูุฉ ูู ูุฐุง ุงููููุฐุฌ ูููู ุถุจุทูุง ุจุงุณุชุฎุฏุงู LoRA. ุนูุฏูุง ูุนูู ูุน ููุงุฐุฌ ๐ค Transformers ุงูุดุงุฆุนุฉุ ุณูุนุฑู PEFT ุงูุทุจูุงุช ุงูุชู ูุฌุจ ุชุทุจูู LoRA ุนูููุงุ ูููู ูู ูุฐู ุงูุญุงูุฉุ ูุชููู ุงูุฃูุฑ ุนูููุง ููุณุชุฎุฏููู ูุงุฎุชูุงุฑ ุงูุทุจูุงุช. ูุชุญุฏูุฏ ุฃุณูุงุก ุงูุทุจูุงุช ุงูุชู ุณูุชู ุถุจุทูุง:

```python
print([(n, type(m)) for n, m in MLP().named_modules()])
```

ูุฌุจ ุฃู ูุทุจุน ูุฐุง ูุง ููู:

```
[('', __main__.MLP),
('seq', torch.nn.modules.container.Sequential),
('seq.0', torch.nn.modules.linear.Linear),
('seq.1', torch.nn.modules.activation.ReLU),
('seq.2', torch.nn.modules.linear.Linear),
('seq.3', torch.nn.modules.activation.ReLU),
('seq.4', torch.nn.modules.linear.Linear),
('seq.5', torch.nn.modules.activation.LogSoftmax)]
```

ูููุชุฑุถ ุฃููุง ูุฑูุฏ ุชุทุจูู LoRA ุนูู ุทุจูุฉ ุงูุฅุฏุฎุงู ูุงูุทุจูุฉ ุงููุฎููุฉุ ูููุง "seq.0" ู"seq.2". ุนูุงูุฉ ุนูู ุฐููุ ูููุชุฑุถ ุฃููุง ูุฑูุฏ ุชุญุฏูุซ ุทุจูุฉ ุงูุฅุฎุฑุงุฌ ุจุฏูู LoRAุ ูุงูุชู ุณุชููู "seq.4". ุณูููู ุงูุชูููู ุงูููุงุจู ููุง ููู:

```python
from peft import LoraConfig

config = LoraConfig(
    target_modules=["seq.0", "seq.2"],
    modules_to_save=["seq.4"],
)
```

ูุน ุฐููุ ูููููุง ุฅูุดุงุก ูููุฐุฌ PEFT ุงูุฎุงุต ุจูุง ูุงูุชุญูู ูู ูุณุจุฉ ุงููุนููุงุช ุงููุฏุฑุจุฉ:

```python
from peft import get_peft_model

model = MLP()
peft_model = get_peft_model(model, config)
peft_model.print_trainable_parameters()
# prints trainable params: 56,164 || all params: 4,100,164 || trainable%: 1.369798866581922
```

ุฃุฎูุฑูุงุ ูููููุง ุงุณุชุฎุฏุงู ุฃู ุฅุทุงุฑ ุชุฏุฑูุจ ูุฑูุฏูุ ุฃู ูุชุงุจุฉ ุญููุฉ ุงูุชุฌููุฒ ุงูุฎุงุตุฉ ุจูุงุ ูุชุฏุฑูุจ ูููุฐุฌ "peft_model".

ููุซุงู ูุงููุ ุฑุงุฌุน [ุฏูุชุฑ ุงูููุงุญุธุงุช ูุฐุง](https://github.com/huggingface/peft/blob/main/examples/multilayer_perceptron/multilayer_perceptron_lora.ipynb).

## ููุงุฐุฌ timm

ุชุญุชูู ููุชุจุฉ [timm](https://huggingface.co/docs/timm/index) ุนูู ุนุฏุฏ ูุจูุฑ ูู ููุงุฐุฌ ุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ ุงููุฏุฑุจุฉ ูุณุจููุง. ูููู ุฃูุถูุง ุถุจุท ุชูู ุงูููุงุฐุฌ ุจุงุณุชุฎุฏุงู PEFT. ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ููููุฉ ุนูู ุฐูู ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ.

ููุจุฏุกุ ุชุฃูุฏ ูู ุชุซุจูุช timm ูู ุจูุฆุฉ Python:

```bash
python -m pip install -U timm
```

ุจุนุฏ ุฐููุ ูููู ุจุชุญููู ูููุฐุฌ timm ููููุฉ ุชุตููู ุงูุตูุฑ:

```python
import timm

num_classes = ...
model_id = "timm/poolformer_m36.sail_in1k"
model = timm.create_model(model_id, pretrained=True, num_classes=num_classes)
```

ูุฑุฉ ุฃุฎุฑูุ ูุชุนูู ุนูููุง ุงุชุฎุงุฐ ูุฑุงุฑ ุจุดุฃู ุงูุทุจูุงุช ุงูุชู ุณูุชู ุชุทุจูู LoRA ุนูููุง. ูุธุฑูุง ูุฃู LoRA ุชุฏุนู ุทุจูุงุช 2D convุ ููุธุฑูุง ูุฃู ุชูู ุงูุทุจูุงุช ูู ุนูุตุฑ ุจูุงุก ุฑุฆูุณู ูู ูุฐุง ุงููููุฐุฌุ ููุฌุจ ุนูููุง ุชุทุจูู LoRA ุนูู ุทุจูุงุช 2D conv. ูุชุญุฏูุฏ ุฃุณูุงุก ุชูู ุงูุทุจูุงุชุ ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ุฌููุน ุฃุณูุงุก ุงูุทุจูุงุช:

```python
print([(n, type(m)) for n, m in model.named_modules()])
```

ุณูููู ูุฐุง ุจุทุจุงุนุฉ ูุงุฆูุฉ ุทูููุฉ ุฌุฏูุงุ ูุณูุธูุฑ ููุท ุฃูู ุจุถุนุฉ ูููุง:

```
[('', timm.models.metaformer.MetaFormer),
('stem', timm.models.metaformer.Stem),
('stem.conv', torch.nn.modules.conv.Conv2d),
('stem.norm', torch.nn.modules.linear.Identity),
('stages', torch.nn.modules.container.Sequential),
('stages.0', timm.models.metaformer.MetaFormerStage),
('stages.0.downsample', torch.nn.modules.linear.Identity),
('stages.0.blocks', torch.nn.modules.container.Sequential),
('stages.0.blocks.0', timm.models.metaformer.MetaFormerBlock),
('stages.0.blocks.0.norm1', timm.layers.norm.GroupNorm1),
('stages.0.blocks.0.token_mixer', timm.models.metaformer.Pooling),
('stages.0.blocks.0.token_mixer.pool', torch.nn.modules.pooling.AvgPool2d),
('stages.0.blocks.0.drop_path1', torch.nn.modules.linear.Identity),
('stages.0.blocks.0.layer_scale1', timm.models.metaformer.Scale),
('stages.0.blocks.0.res_scale1', torch.nn.modules.linear.Identity),
('stages.0.blocks.0.norm2', timm.layers.norm.GroupNorm1),
('stages.0.blocks.0.mlp', timm.layers.mlp.Mlp),
('stages.0.blocks.0.mlp.fc1', torch.nn.modules.conv.Conv2d),
('stages.0.blocks.0.mlp.act', torch.nn.modules.activation.GELU),
('stages.0.blocks.0.mlp.drop1', torch.nn.modules.dropout.Dropout),
('stages.0.blocks.0.mlp.norm', torch.nn.modules.linear.Identity),
('stages.0.blocks.0.mlp.fc2', torch.nn.modules.conv.Conv2d),
('stages.0.blocks.0.mlp.drop2', torch.nn.modules.dropout.Dropout),
('stages.0.blocks.0.drop_path2', torch.nn.modules.linear.Identity),
('stages.0.blocks.0.layer_scale2', timm.models.metaformer.Scale),
('stages.0.blocks.0.res_scale2', torch.nn.modules.linear.Identity),
('stages.0.blocks.1', timm.models.metaformer.MetaFormerBlock),
('stages.0.blocks.1.norm1', timm.layers.norm.GroupNorm1),
('stages.0.blocks.1.token_mixer', timm.models.metaformer.Pooling),
('stages.0.blocks.1.token_mixer.pool', torch.nn.modules.pooling.AvgPool2d),
...
('head.global_pool.flatten', torch.nn.modules.linear.Identity),
('head.norm', timm.layers.norm.LayerNorm2d),
('head.flatten', torch.nn.modules.flatten.Flatten),
('head.drop', torch.nn.modules.linear.Identity),
('head.fc', torch.nn.modules.linear.Linear)]
]
```

ุนูุฏ ุงููุญุต ุงูุฏูููุ ูุฑู ุฃู ุทุจูุงุช 2D conv ููุง ุฃุณูุงุก ูุซู "stages.0.blocks.0.mlp.fc1" ู"stages.0.blocks.0.mlp.fc2". ููู ูููููุง ูุทุงุจูุฉ ุฃุณูุงุก ุงูุทุจูุงุช ูุฐู ุนูู ูุฌู ุงูุชุญุฏูุฏุ ููููู ูุชุงุจุฉ [ุงูุชุนุจูุฑุงุช ุงูุนุงุฏูุฉ](https://docs.python.org/3/library/re.html) ููุทุงุจูุฉ ุฃุณูุงุก ุงูุทุจูุงุช. ูู ุญุงูุชูุงุ ูุฌุจ ุฃู ูุคุฏู ุงูุชุนุจูุฑ ุงูุนุงุฏู `r".*\.mlp\.fc\d"` ุฅูู ุงููููุฉ.

ุนูุงูุฉ ุนูู ุฐููุ ููุง ูู ุงูุญุงู ูู ุงููุซุงู ุงูุฃููุ ูุฌุจ ุนูููุง ุงูุชุฃูุฏ ูู ุชุญุฏูุซ ุทุจูุฉ ุงูุฅุฎุฑุงุฌุ ูู ูุฐู ุงูุญุงูุฉ ุฑุฃุณ ุงูุชุตููู. ุจุงููุธุฑ ุฅูู ููุงูุฉ ุงููุงุฆูุฉ ุงููุทุจูุนุฉ ุฃุนูุงูุ ูููููุง ุฃู ูุฑู ุฃููุง ุชุณูู "head.fc". ูุน ูุถุน ุฐูู ูู ุงูุงุนุชุจุงุฑุ ูููุง ููู ุชูููู LoRA ุงูุฎุงุต ุจูุง:

```python
config = LoraConfig(target_modules=r".*\.mlp\.fc\d", modules_to_save=["head.fc"])
```

ุจุนุฏ ุฐููุ ูุญุชุงุฌ ููุท ุฅูู ุฅูุดุงุก ูููุฐุฌ PEFT ุนู ุทุฑูู ุชูุฑูุฑ ูููุฐุฌ ุงูุฃุณุงุณ ูุชููููู ุฅูู `get_peft_model`:

```python
peft_model = get_peft_model(model, config)
peft_model.print_trainable_parameters()
# prints trainable params: 1,064,454 || all params: 56,467,974 || trainable%: 1.88505789139876
```

ูุธูุฑ ูุฐุง ุฃููุง ูุญุชุงุฌ ููุท ุฅูู ุชุฏุฑูุจ ุฃูู ูู 2% ูู ุฌููุน ุงููุนููุงุชุ ููู ููุณุจ ูุจูุฑ ูู ุงูููุงุกุฉ.

ููุซุงู ูุงููุ ุฑุงุฌุน [ุฏูุชุฑ ุงูููุงุญุธุงุช ูุฐุง](https://github.com/huggingface/peft/blob/main/examples/image_classification/image_classification_timm_peft_lora.ipynb).

## ุจููุงุช Transformers ุงูุฌุฏูุฏุฉ

ุนูุฏูุง ูุชู ุฅุตุฏุงุฑ ุจููุงุช Transformers ุฌุฏูุฏุฉ ูุดุนุจูุฉุ ูุจุฐู ูุตุงุฑู ุฌูุฏูุง ูุฅุถุงูุชูุง ุจุณุฑุนุฉ ุฅูู PEFT. ุฅุฐุง ุตุงุฏูุช ูููุฐุฌ Transformers ุบูุฑ ูุฏุนูู ุจุดูู ุงูุชุฑุงุถูุ ููุง ุชูููุ ููู ุงููุญุชูู ุฃู ูุนูู ุนูู ุฃู ุญุงู ุฅุฐุง ุชู ุชุนููู ุงูุชูููู ุจุดูู ุตุญูุญ. ุนูู ูุฌู ุงูุชุญุฏูุฏุ ูุฌุจ ุนููู ุชุญุฏูุฏ ุงูุทุจูุงุช ุงูุชู ูุฌุจ ุชูููููุง ูุชุนููููุง ุจุดูู ุตุญูุญ ุนูุฏ ุชููุฆุฉ ูุฆุฉ ุงูุชูููู ุงูููุงุจูุฉุ ุนูู ุณุจูู ุงููุซุงู `LoraConfig`. ูููุง ููู ุจุนุถ ุงููุตุงุฆุญ ุงูุชู ุชุณุงุนุฏ ูู ุฐูู.

ูุฎุทูุฉ ุฃูููุ ูู ุงูุฌูุฏ ุงูุชุญูู ูู ุงูููุงุฐุฌ ุงูููุฌูุฏุฉ ููุญุตูู ุนูู ุงูุฅููุงู. ููููู ุงูุนุซูุฑ ุนูููุง ุฏุงุฎู [constants.py](https://github.com/huggingface/peft/blob/main/src/peft/utils/constants.py) ูู ูุณุชูุฏุน PEFT. ุบุงูุจูุง ูุง ุณุชุฌุฏ ุจููุฉ ููุงุซูุฉ ุชุณุชุฎุฏู ููุณ ุงูุฃุณูุงุก. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงูุช ุจููุฉ ุงููููุฐุฌ ุงูุฌุฏูุฏ ูู ุชููุน ููููุฐุฌ "mistral" ูุชุฑูุฏ ุชุทุจูู LoRAุ ูููููู ุฃู ุชุฑู ุฃู ุงูุฅุฏุฎุงู ุงูุฎุงุต ุจู "mistral" ูู `TRANSFORMERS_MODELS_TO_LORA_TARGET_MODULES_MAPPING` ูุญุชูู ุนูู `["q_proj"ุ "v_proj"]`. ูุฎุจุฑู ูุฐุง ุจุฃูู ุจุงููุณุจุฉ ูููุงุฐุฌ "mistral"ุ ูุฌุจ ุฃู ุชููู `target_modules` ูู LoRA ูู `["q_proj"ุ "v_proj"]`:

```python
from peft import LoraConfig, get_peft_model

my_mistral_model = ...
config = LoraConfig(
    target_modules=["q_proj", "v_proj"],
    ...,  # other LoRA arguments
)
peft_model = get_peft_model(my_mistral_model, config)
```

ุฅุฐุง ูู ูุณุงุนุฏ ุฐููุ ูุชุญูู ูู ุงููุญุฏุงุช ุงูููุทูุฉ ุงูููุฌูุฏุฉ ูู ุจููุฉ ุงููููุฐุฌ ุงูุฎุงุต ุจู ุจุงุณุชุฎุฏุงู ุทุฑููุฉ `named_modules` ูุญุงูู ุชุญุฏูุฏ ุทุจูุงุช ุงูุงูุชูุงูุ ุฎุงุตุฉ ุทุจูุงุช ุงูููุชุงุญ ูุงูุงุณุชุนูุงู ูุงููููุฉ. ุบุงูุจูุง ูุง ูููู ููุฐู ุงูุทุจูุงุช ุฃุณูุงุก ูุซู `c_attn` ู`query` ู`q_proj`ุ ููุง ุฅูู ุฐูู. ุทุจูุฉ ุงูููุชุงุญ ููุณุช ุฏุงุฆููุง ูููููููุฉุ ููู ุงูุฃูุถู ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุชุถููููุง ูุคุฏู ุฅูู ุฃุฏุงุก ุฃูุถู.

ุจุงูุฅุถุงูุฉ ุฅูู ุฐููุ ุชุนุฏ ุงูุทุจูุงุช ุงูุฎุทูุฉ ุฃูุฏุงููุง ุดุงุฆุนุฉ ููุชููู (ุนูู ุณุจูู ุงููุซุงูุ ูู [ูุฑูุฉ QLoRA](https://arxiv.org/abs/2305.14314)ุ ููุชุฑุญ ุงููุคูููู ุชูููููุง ุฃูุถูุง). ุบุงูุจูุง ูุง ุชุญุชูู ุฃุณูุงุก ูุฐู ุงูุทุจูุงุช ุนูู ุณูุงุณู ุงูุฃุญุฑู "fc" ุฃู "dense".

ุฅุฐุง ููุช ุชุฑูุฏ ุฅุถุงูุฉ ูููุฐุฌ ุฌุฏูุฏ ุฅูู PEFTุ ููุฑุฌู ุฅูุดุงุก ุฅุฏุฎุงู ูู [constants.py](https://github.com/huggingface/peft/blob/main/src/peft/utils/constants.py) ูุฅุฑุณุงู ุทูุจ ุณุญุจ ุนูู [ุงููุณุชูุฏุน](https://github.com/huggingface/peft/pulls). ูุง ุชูุณ ุชุญุฏูุซ [README](https://github.com/huggingface/peft#models-support-matrix) ุฃูุถูุง.

## ุงูุชุญูู ูู ุงููุนููุงุช ูุงูุทุจูุงุช

ููููู ุงูุชุญูู ููุง ุฅุฐุง ููุช ูุฏ ุทุจูุช ุทุฑููุฉ PEFT ุนูู ูููุฐุฌู ุจุดูู ุตุญูุญ ุจุนุฏุฉ ุทุฑู.

* ุชุญูู ูู ูุณุจุฉ ุงููุนููุงุช ุงูุชู ูููู ุชุฏุฑูุจูุง ุจุงุณุชุฎุฏุงู ุทุฑููุฉ [`~PeftModel.print_trainable_parameters`] . ุฅุฐุง ูุงู ูุฐุง ุงูุฑูู ุฃูู ุฃู ุฃุนูู ููุง ูู ูุชููุนุ ูุชุญูู ูู ุชูุซูู ุงููููุฐุฌ ุนู ุทุฑูู ุทุจุงุนุฉ ุงููููุฐุฌ. ููุธูุฑ ูุฐุง ุฃุณูุงุก ุฌููุน ุฃููุงุน ุงูุทุจูุงุช ูู ุงููููุฐุฌ. ุชุฃูุฏ ูู ุงุณุชุจุฏุงู ุงูุทุจูุงุช ุงููุณุชูุฏูุฉ ููุท ุจุทุจูุงุช ุงููุญูู. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ุชู ุชุทุจูู LoRA ุนูู ุทุจูุงุช `nn.Linear`ุ ููุฌุจ ุฃูุง ุชุฑู ุณูู ุงุณุชุฎุฏุงู ุทุจูุงุช `lora.Linear`.

```py
peft_model.print_trainable_parameters()
```

* ุทุฑููุฉ ุฃุฎุฑู ูุนุฑุถ ุงูุทุจูุงุช ุงูููููุฉ ูู ุงุณุชุฎุฏุงู ุงูุณูุฉ `targeted_module_names` ูุฅุฏุฑุงุฌ ุงุณู ูู ูุญุฏุฉ ููุทูุฉ ุชู ุชูููููุง.

```python
print(peft_model.targeted_module_names)
```

## ุฃููุงุน ุงููุญุฏุงุช ุงูููุทูุฉ ุบูุฑ ุงููุฏุนููุฉ

ุชุนูู ุงูุทุฑู ูุซู LoRA ููุท ุฅุฐุง ูุงูุช ุงููุญุฏุงุช ุงูููุทูุฉ ุงููุณุชูุฏูุฉ ูุฏุนููุฉ ุจูุงุณุทุฉ PEFT. ุนูู ุณุจูู ุงููุซุงูุ ูู ุงููููู ุชุทุจูู LoRA ุนูู ุทุจูุงุช `nn.Linear` ู`nn.Conv2d`ุ ูููู ููุณุ ุนูู ุณุจูู ุงููุซุงูุ ุนูู `nn.LSTM`. ุฅุฐุง ูุฌุฏุช ุฃู ูุฆุฉ ุงูุทุจูุฉ ุงูุชู ุชุฑูุฏ ุชุทุจูู PEFT ุนูููุง ุบูุฑ ูุฏุนููุฉุ ูููููู:

- ุชุญุฏูุฏ ุชุนููู ูุฎุตุต ููุชูููุถ ุงูุฏููุงูููู ูููุญุฏุงุช ุงูููุทูุฉ ุงููุฎุตุตุฉ ูู LoRA
- ูุชุญ [ูุถูุฉ](https://github.com/huggingface/peft/issues) ูุทูุจ ุงูููุฒุฉ ุญูุซ ุณูููุฐูุง ุงููุดุฑููู ุฃู ูุฑุดุฏููู ุญูู ููููุฉ ุชูููุฐูุง ุจููุณู ุฅุฐุง ูุงู ุงูุทูุจ ุนูู ูุฐุง ุงูููุน ูู ุงููุญุฏุงุช ุงูููุทูุฉ ูุฑุชูุนูุง ุจุฏุฑุฌุฉ ูุงููุฉ
### ุฏุนู ุชุฌุฑูุจู ููุชูุฑูู ุงูุฏููุงูููู ูููุญุฏุงุช ุงูููุทูุฉ ุงููุฎุตุตุฉ ูู LoRA

> [!WARNING]
> ูุฐู ุงูููุฒุฉ ุชุฌุฑูุจูุฉ ููุฏ ุชุชุบูุฑ ุญุณุจ ุงุณุชูุจุงู ุงููุฌุชูุน ููุง. ุณููุฏู ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุนุงูุฉ ููุณุชูุฑุฉ ุฅุฐุง ูุงู ููุงู ุทูุจ ูุจูุฑ ุนูููุง.

ูุฏุนู PEFT ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุชุฌุฑูุจูุฉ ูุฃููุงุน ุงููุญุฏุงุช ุงูููุทูุฉ ุงููุฎุตุตุฉ ูู LoRA. ูููุชุฑุถ ุฃู ูุฏูู ุชูููุฐ LoRA ูู LSTMs. ุนุงุฏุฉุ ูู ุชุชููู ูู ุฅุฎุจุงุฑ PEFT ุจุงุณุชุฎุฏุงููุ ุญุชู ุฅุฐุง ูุงู ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ูุนูู ูุน PEFT. ููุน ุฐููุ ูุฅู ูุฐุง ูููู ูุน ุงูุชูุฑูู ุงูุฏููุงูููู ููุทุจูุงุช ุงููุฎุตุตุฉ.

ุชุจุฏู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุงูุชุฌุฑูุจูุฉ ุญุงูููุง ุนูู ุงููุญู ุงูุชุงูู:

```python
class MyLoraLSTMLayer:
...

base_model = ...  # ุชุญููู ูููุฐุฌ ุงูุฃุณุงุณ ุงูุฐู ูุณุชุฎุฏู LSTMs

# ุฅุถุงูุฉ ุฃุณูุงุก ุทุจูุฉ LSTM ุฅูู target_modules
config = LoraConfig(..., target_modules=["lstm"])
# ุชุญุฏูุฏ ุฎุฑูุทุฉ ูู ููุน ุทุจูุฉ ุงูุฃุณุงุณ ุฅูู ููุน ุทุจูุฉ LoRA
custom_module_mapping = {nn.LSTM: MyLoraLSTMLayer}
# ุชุณุฌูู ุฎุฑูุทุฉ ุฌุฏูุฏุฉ
config._register_custom_module(custom_module_mapping)
# ุจุนุฏ ุงูุชุณุฌููุ ูู ุจุฅูุดุงุก ูููุฐุฌ PEFT
peft_model = get_peft_model(base_model, config)
# ูู ุจุงูุชุฏุฑูุจ
```

<Tip>

ุนูุฏ ุงุณุชุฏุนุงุก [`get_peft_model`]`[`get_peft_model`]`ุ ุณุชุฑู ุชุญุฐูุฑูุง ูุฃู PEFT ูุง ูุชุนุฑู ุนูู ููุน ุงููุญุฏุฉ ุงูููุทูุฉ ุงููุณุชูุฏูุฉ. ูู ูุฐู ุงูุญุงูุฉุ ููููู ุชุฌุงูู ูุฐุง ุงูุชุญุฐูุฑ.

</Tip>

ูู ุฎูุงู ุชูููุฑ ุฎุฑูุทุฉ ูุฎุตุตุฉุ ูุชุญูู PEFT ุฃููุงู ูู ุทุจูุงุช ูููุฐุฌ ุงูุฃุณุงุณ ููุงุจู ุงูุฎุฑูุทุฉ ุงููุฎุตุตุฉ ููููู ุจุงูุชูุฑูู ุฅูู ููุน ุทุจูุฉ LoRA ุงููุฎุตุต ุฅุฐุง ูุงู ููุงู ุชุทุงุจู. ุฅุฐุง ูู ููู ููุงู ุชุทุงุจูุ ูุชุญูู PEFT ูู ุฃููุงุน ุทุจูุงุช LoRA ุงููุฏูุฌุฉ ููุชุทุงุจู.

ูุฐููุ ูููู ุฃูุถูุง ุงุณุชุฎุฏุงู ูุฐู ุงูููุฒุฉ ูุชุฌุงูุฒ ููุทู ุงูุชูุฑูู ุงูููุฌูุฏุ ุนูู ุณุจูู ุงููุซุงู ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุฎุฏุงู ุทุจูุฉ LoRA ุงูุฎุงุตุฉ ุจู ูู `nn.Linear` ุจุฏูุงู ูู ุงุณุชุฎุฏุงู ุงูุทุจูุฉ ุงูุชู ูููุฑูุง PEFT.

ุนูุฏ ุฅูุดุงุก ูุญุฏุฉ LoRA ุงููุฎุตุตุฉ ุงูุฎุงุตุฉ ุจูุ ูุฑุฌู ุงุชุจุงุน ููุณ ุงูููุงุนุฏ ููุง ูู [ูุญุฏุงุช LoRA ุงูููุฌูุฏุฉ](https://github.com/huggingface/peft/blob/main/src/peft/tuners/lora/layer.py). ููุงู ุจุนุถ ุงููููุฏ ุงููููุฉ ุงูุชู ูุฌุจ ูุฑุงุนุงุชูุง:

- ูุฌุจ ุฃู ุชุฑุซ ุงููุญุฏุฉ ุงููุฎุตุตุฉ ูู `nn.Module` ู`peft.tuners.lora.layer.LoraLayer`.
- ูุฌุจ ุฃู ุชุญุชูู ุทุฑููุฉ `__init__` ูููุญุฏุฉ ุงููุฎุตุตุฉ ุนูู ูุณูุทูู ููุถุนููู `base_layer` ู`adapter_name`. ุจุนุฏ ุฐููุ ููุงู ูุณูุทุงุช `**kwargs` ุฅุถุงููุฉ ููููู ุงุณุชุฎุฏุงููุง ุฃู ุชุฌุงูููุง.
- ูุฌุจ ุชุฎุฒูู ุงููุนููุงุช ุงููุงุจูุฉ ููุชุนูู ูู `nn.ModuleDict` ุฃู `nn.ParameterDict`ุ ุญูุซ ูุชูุงูู ุงูููุชุงุญ ูุน ุงุณู ุงููุญูู ุงููุญุฏุฏ (ุชุฐูุฑ ุฃูู ูููู ุฃู ูููู ูููููุฐุฌ ุฃูุซุฑ ูู ูุญูู ูู ููุณ ุงูููุช).
- ูุฌุจ ุฃู ูุจุฏุฃ ุงุณู ุณูุงุช ุงููุนููุงุช ุงููุงุจูุฉ ููุชุนูู ุจู `"lora_"``ุ ุนูู ุณุจูู ุงููุซุงู `self.lora_new_param = ...`.
- ุจุนุถ ุงูุทุฑู ุงุฎุชูุงุฑูุฉุ ุนูู ุณุจูู ุงููุซุงูุ ุฃูุช ุจุญุงุฌุฉ ููุท ุฅูู ุชูููุฐ `merge` ู`unmerge` ุฅุฐุง ููุช ุชุฑูุฏ ุฏุนู ุฏูุฌ ุงูุฃูุฒุงู.

ุญุงูููุงุ ูุง ุชุณุชูุฑ ูุนูููุงุช ุงููุญุฏุฉ ุงูููุทูุฉ ุงููุฎุตุตุฉ ุนูุฏ ุญูุธ ุงููููุฐุฌ. ุนูุฏ ุชุญููู ุงููููุฐุฌุ ูุฌุจ ุนููู ุชุณุฌูู ุงููุญุฏุงุช ุงูููุทูุฉ ุงููุฎุตุตุฉ ูุฑุฉ ุฃุฎุฑู.

```python
# ูุนูู ุงูุญูุธ ุฏุงุฆููุง ููุง ูู ููุดูู ูุนููุงุช ุงููุญุฏุงุช ุงูููุทูุฉ ุงููุฎุตุตุฉ
peft_model.save_pretrained(<model-path>)

# ุชุญููู ุงููููุฐุฌ ูุงุญููุง:
base_model = ...
# ุชุญููู ุชูููู LoRA ุงูุฐู ููุช ุจุญูุธู ุณุงุจููุง
config = LoraConfig.from_pretrained(<model-path>)
# ุชุณุฌูู ุงููุญุฏุฉ ุงูููุทูุฉ ุงููุฎุตุตุฉ ูุฑุฉ ุฃุฎุฑูุ ุจููุณ ุทุฑููุฉ ุงููุฑุฉ ุงูุฃููู
custom_module_mapping = {nn.LSTM: MyLoraLSTMLayer}
config._register_custom_module(custom_module_mapping)
# ุชูุฑูุฑ ูุซูู ุงูุชูููู ุฅูู from_pretrained:
peft_model = PeftModel.from_pretrained(model, tmp_path / "lora-custom-module"ุ config=config)
```

ุฅุฐุง ููุช ุชุณุชุฎุฏู ูุฐู ุงูููุฒุฉ ูุชุฌุฏูุง ูููุฏุฉุ ุฃู ุฅุฐุง ูุงุฌูุชู ูุดููุงุชุ ูุฃุฎุจุฑูุง ูู ุฎูุงู ุฅูุดุงุก ูุดููุฉ ุฃู ููุงูุดุฉ ุนูู GitHub. ูุณูุญ ููุง ุฐูู ุจุชูุฏูุฑ ุงูุทูุจ ุนูู ูุฐู ุงูููุฒุฉ ูุฅุถุงูุฉ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุนุงูุฉ ุฅุฐุง ูุงู ุงูุทูุจ ูุฑุชูุนูุง ุจุฏุฑุฌุฉ ูุงููุฉ.