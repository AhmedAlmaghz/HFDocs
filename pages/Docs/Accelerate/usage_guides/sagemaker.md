# Amazon SageMaker

ูุฏูุช Hugging Face ู Amazon ุญุงููุงุช ุฌุฏูุฏุฉ ูู [Hugging Face Deep Learning Containers (DLCs)](https://github.com/aws/deep-learning-containers/blob/master/available_images.md#huggingface-training-containers) ูุชุณููู ุชุฏุฑูุจ ููุงุฐุฌ Hugging Face Transformer ูู [Amazon SageMaker](https://aws.amazon.com/sagemaker/).

## ุงูุจุฏุก

### ุงูุฅุนุฏุงุฏ ูุงูุชุซุจูุช

ูุจู ุฃู ุชุชููู ูู ุชุดุบูู ูุตูุต ๐ค Accelerate ุนูู Amazon SageMakerุ ูุฌุจ ุนููู ุงูุงุดุชุฑุงู ูู ุญุณุงุจ AWS. ุฅุฐุง ูู ููู ูุฏูู ุญุณุงุจ AWS ุจุนุฏุ ุชุนุฑู ุนูู ุงููุฒูุฏ [ููุง](https://docs.aws.amazon.com/sagemaker/latest/dg/gs-set-up.html).

ุจุนุฏ ุญุตููู ุนูู ุญุณุงุจ AWSุ ูุฌุจ ุชุซุจูุช ุญุฒูุฉ ุจุฑุงูุฌ sagemaker ูู ๐ค Accelerate ุจุงุณุชุฎุฏุงู ูุง ููู:

```bash
pip install "accelerate[sagemaker]" --upgrade
```

๐ค Accelerate ูุณุชุฎุฏู ุญุงูููุง ุญุงููุงุช ๐ค DLCุ ูุน `transformers` ู`datasets` ู`tokenizers` ูุซุจุชุฉ ูุณุจููุง. ๐ค Accelerate ุบูุฑ ูุชููุฑุฉ ูู DLC ุจุนุฏ (ุณูุชู ุฅุถุงูุชูุง ูุฑูุจูุง!) ูุฐูู ูุงุณุชุฎุฏุงููุง ุฏุงุฎู Amazon SageMakerุ ูุฌุจ ุนููู ุฅูุดุงุก ููู `requirements.txt` ูู ููุณ ุงูุฏููู ุญูุซ ููุฌุฏ ูุต ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู ูุฅุถุงูุชู ูุงุนุชูุงุฏ:

```
accelerate
```

ูุฌุจ ุฃูุถูุง ุฅุถุงูุฉ ุฃู ุชุจุนูุงุช ุฃุฎุฑู ูุฏูู ุฅูู ูุฐุง ุงูููู `requirements.txt`.

### ุชูููู ๐ค Accelerate

ููููู ุชูููู ุชูููู ุงูุชุดุบูู ูู Amazon SageMaker ุจููุณ ุงูุทุฑููุฉ ุงูุชู ุชููู ุจูุง ููุธุงุฆู ุงูุชุฏุฑูุจ ุบูุฑ SageMaker ุจุงุณุชุฎุฏุงู ูุงุฌูุฉ ุณุทุฑ ุงูุฃูุงูุฑ ๐ค Accelerate:

```bash
accelerate config
# ูู ุฃู ุจูุฆุฉ ุญูุณุจุฉ ุชุนููุ ([0] ูุฐู ุงูุขูุฉุ [1] AWS (Amazon SageMaker)): 1
```

๐ค Accelerate ุณุชูุฑ ุนุจุฑ ุงุณุชุจูุงู ุญูู ุฅุนุฏุงุฏ Amazon SageMaker ูุฅูุดุงุก ููู ุชูููู ููููู ุชุญุฑูุฑู.

<Tip>

๐ค Accelerate ูุง ูุญูุธ ุฃู ูู ุจูุงูุงุช ุงุนุชูุงุฏู.

</Tip>

### ุฅุนุฏุงุฏ ูุต ุถุจุท ุงูุฏูุฉ ูู ๐ค Accelerate

ูุต ุงูุชุฏุฑูุจ ูุดุงุจู ุฌุฏูุง ููุต ุงูุชุฏุฑูุจ ุงูุฐู ูุฏ ุชููู ุจุชุดุบููู ุฎุงุฑุฌ SageMakerุ ูููู ูุญูุธ ูููุฐุฌู ุจุนุฏ ุงูุชุฏุฑูุจุ ูุฌุจ ุนููู ุชุญุฏูุฏ ุฅูุง `/opt/ml/model` ุฃู ุงุณุชุฎุฏุงู `os.environ ["SM_MODEL_DIR"]` ูุฏููู ุญูุธ ุงูุฎุงุต ุจู. ุจุนุฏ ุงูุชุฏุฑูุจุ ูุชู ุชุญููู ุงูุจุฑุงูุฌ ุงููุตูุฉ ูู ูุฐุง ุงูุฏููู ุฅูู S3:

```diff
- torch.save('/opt/ml/model`)
+ accelerator.save('/opt/ml/model')
```

<Tip warning={true}>

ูุง ุชุฏุนู SageMaker ุฅุฌุฑุงุกุงุช argparse. ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุฎุฏุงูุ ุนูู ุณุจูู ุงููุซุงูุ ุงููุณูุทุงุช ุงูููุทููุฉุ ููุฌุจ ุนููู ุชุญุฏูุฏ ุงูููุน ููููุฉ ููุทููุฉ ูู ูุตู ูุชูููุฑ ูููุฉ ุตุฑูุญุฉ ุตุญูุญุฉ ุฃู ุฎุงุทุฆุฉ ููุฐุง ุงููุณูุท. [[REF]](https://sagemaker.readthedocs.io/en/stable/frameworks/pytorch/using_pytorch.html#prepare-a-pytorch-training-script).

</Tip>

### ุฅุทูุงู ุงูุชุฏุฑูุจ

ููููู ุฅุทูุงู ุงูุชุฏุฑูุจ ุจุงุณุชุฎุฏุงู ูุงุฌูุฉ ุณุทุฑ ุงูุฃูุงูุฑ ๐ค Accelerate ุจุงุณุชุฎุฏุงู ูุง ููู:

```
accelerate launch path_to_script.py --args_to_the_script
```

ุณูุคุฏู ูุฐุง ุฅูู ุชุดุบูู ูุต ุงูุชุฏุฑูุจ ุจุงุณุชุฎุฏุงู ุชููููู. ูู ูุง ุนููู ูุนูู ูู ุชูููุฑ ุฌููุน ุงูุญุฌุฌ ุงูุชู ูุญุชุงุฌูุง ูุต ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู ูุญุฌุฌ ูุณูุงุฉ.

**ุฃูุซูุฉ**

<Tip>

ุฅุฐุง ููุช ุชุดุบู ุฃุญุฏ ุงููุตูุต ุงููุซุงููุฉุ ููุง ุชูุณ ุฅุถุงูุฉ `accelerator.save('/opt/ml/model')` ุฅููู.

</Tip>

```bash
accelerate launch ./examples/sagemaker_example.py
```

ุงูุฅุฎุฑุงุฌ:

```
Configuring Amazon SageMaker environment
Converting Arguments to Hyperparameters
Creating Estimator
2021-04-08 11:56:50 Starting - Starting the training job...
2021-04-08 11:57:13 Starting - Launching requested ML instancesProfilerReport-1617883008: InProgress
.........
2021-04-08 11:58:54 Starting - Preparing the instances for training.........
2021-04-08 12:00:24 Downloading - Downloading input data
2021-04-08 12:00:24 Training - Downloading the training image..................
2021-04-08 12:03:39 Training - Training image download completed. Training in progress..
........
epoch 0: {'accuracy': 0.7598039215686274, 'f1': 0.8178438661710037}
epoch 1: {'accuracy': 0.8357843137254902, 'f1': 0.882249560632689}
epoch 2: {'accuracy': 0.8406862745098039, 'f1': 0.8869565217391304}
........
2021-04-08 12:05:40 Uploading - Uploading generated training model
2021-04-08 12:05:40 Completed - Training job completed
Training seconds: 331
Billable seconds: 331
You can find your model data at: s3://your-bucket/accelerate-sagemaker-1-2021-04-08-11-56-47-108/output/model.tar.gz
```

## ุงูููุฒุงุช ุงููุชูุฏูุฉ

### ุงูุชุฏุฑูุจ ุงูููุฒุน: ุงูููุงุฒุงุฉ ุจุงูุจูุงูุงุช

ูู ุจุฅุนุฏุงุฏ ุชูููู ุงูุชุนุฌูู ุนู ุทุฑูู ุชุดุบูู `accelerate config` ูุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุฉ SageMaker ูุฅุนุฏุงุฏู. ูุงุณุชุฎุฏุงู SageMaker DDPุ ุญุฏุฏ ุฐูู ุนูุฏ ุงูุณุคุงู

`ูุง ูู ุงููุถุน ุงูููุฒุนุ ([0] ูุง ููุฌุฏ ุชุฏุฑูุจ ููุฒุนุ [1] ุงูููุงุฒุงุฉ ุจุงูุจูุงูุงุช):`.

ูุซุงู ุงูุชูููู ุฃุฏูุงู:

```yaml
base_job_name: accelerate-sagemaker-1
compute_environment: AMAZON_SAGEMAKER
distributed_type: DATA_PARALLEL
ec2_instance_type: ml.p3.16xlarge
iam_role_name: xxxxx
image_uri: null
mixed_precision: fp16
num_machines: 1
profile: xxxxx
py_version: py38
pytorch_version: 1.10.2
region: us-east-1
transformers_version: 4.17.0
use_cpu: false
```

### ุงูุชุฏุฑูุจ ุงูููุฒุน: ุงูููุงุฒุงุฉ ุจุงูููุงุฐุฌ

*ููุฏ ุงูุชุทููุฑ ุญุงูููุงุ ูุณูุชู ุฏุนูู ูุฑูุจูุง.*

### ุญุฒู Python ูุงูุงุนุชูุงุฏุงุช

๐ค Accelerate ูุณุชุฎุฏู ุญุงูููุง ุญุงููุงุช ๐ค DLCุ ูุน `transformers` ู`datasets` ู`tokenizers` ูุซุจุชุฉ ูุณุจููุง. ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุฎุฏุงู ุญุฒู Python ูุฎุชููุฉ/ุฃุฎุฑูุ ูููููู ุงูููุงู ุจุฐูู ุนู ุทุฑูู ุฅุถุงูุชูุง ุฅูู ููู `requirements.txt`. ุณูุชู ุชุซุจูุช ูุฐู ุงูุญุฒู ูุจู ุจุฏุก ูุต ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู.

### ุงูุชุฏุฑูุจ ุงููุญูู: ูุถุน SageMaker ุงููุญูู

ูุณูุญ ุงููุถุน ุงููุญูู ูู ุญุฒูุฉ ุจุฑุงูุฌ SageMaker ุจุชุดุบูู ูุต ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู ูุญูููุง ุฏุงุฎู ุญุงููุฉ HuggingFace DLC (ุญุงููุฉ ุงูุชุนูู ุงูุนููู) ุฃู ุจุงุณุชุฎุฏุงู ุตูุฑุฉ ุญุงููุฉ ูุฎุตุตุฉ. ูุฐุง ูููุฏ ูุชุตุญูุญ ุฃุฎุทุงุก ูุต ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู ูุงุฎุชุจุงุฑู ุฏุงุฎู ุจูุฆุฉ ุงูุญุงููุฉ ุงูููุงุฆูุฉ.

ูุณุชุฎุฏู ุงููุถุน ุงููุญูู Docker compose (*ููุงุญุธุฉ: Docker Compose V2 ุบูุฑ ูุฏุนูู ุจุนุฏ*). ุณุชุชุนุงูู ุญุฒูุฉ ุงูุจุฑุงูุฌ ูุน ุงููุตุงุฏูุฉ ููุงุจู ECR ูุณุญุจ DLC ุฅูู ุจูุฆุชู ุงููุญููุฉ. ููููู ูุญุงูุงุฉ ูุธุงุฆู ุงูุชุฏุฑูุจ CPU (ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ) (ูุญุฏุฉ ูุนุงูุฌุฉ ูุฑูุฒูุฉ ูุงุญุฏุฉ ููุชุนุฏุฏุฉ) ูGPU (ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช) (ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ) ูู SageMaker.

ูุงุณุชุฎุฏุงู ุงููุถุน ุงููุญููุ ูุฌุจ ุนููู ุชุนููู ููุน ูุซูู EC2 ุงูุฎุงุต ุจู ุฅูู `local`.

```yaml
ec2_instance_type: local
```

### ุงูุชูููู ุงููุชูุฏู

ูุณูุญ ุงูุชูููู ุจุชุฌุงูุฒ ุงููุนููุงุช ูู [ุงูููุฏุฑ](https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html). ูุฌุจ ุชุทุจูู ูุฐู ุงูุฅุนุฏุงุฏุงุช ูู ููู ุงูุชูููู ููู ููุณุช ุฌุฒุกูุง ูู `accelerate config`. ููููู ุงูุชุญูู ูู ุงูุนุฏูุฏ ูู ุงูุฌูุงูุจ ุงูุฅุถุงููุฉ ููุธููุฉ ุงูุชุฏุฑูุจุ ุนูู ุณุจูู ุงููุซุงูุ ุงุณุชุฎุฏุงู ูุซููุงุช Spotุ ูุชูููู ุงูุนุฒู ุงูุดุจูู ูุงููุฒูุฏ.

```yaml
additional_args:
# ุชูููู ุงูุนุฒู ุงูุดุจูู ูุชูููุฏ ุงููุตูู ุฅูู ุงูุฅูุชุฑูุช ููุญุงููุงุช
enable_network_isolation: True
```

ููููู ุงูุนุซูุฑ ุนูู ุฌููุน ุงูุชููููุงุช ุงููุชุงุญุฉ [ููุง](https://sagemaker.readthedocs.io/en/stable/api/training/estimators.html).

### ุงุณุชุฎุฏุงู ูุซููุงุช Spot

ููููู ุงุณุชุฎุฏุงู ูุซููุงุช Spotุ ุนูู ุณุจูู ุงููุซุงูุ ุจุงุณุชุฎุฏุงู (ุฑุงุฌุน [ุงูุชูููู ุงููุชูุฏู](#ุงูุชูููู ุงููุชูุฏู)):

```yaml
additional_args:
use_spot_instances: True
max_wait: 86400
```

*ููุงุญุธุฉ: ุชุฎุถุน ูุซููุงุช Spot ููุฅููุงุก ูุงุณุชูุฑุงุฑ ุงูุชุฏุฑูุจ ูู ููุทุฉ ุชูุชูุด. ูุง ูุชู ุงูุชุนุงูู ูุน ูุฐุง ูู ๐ค Accelerate ุฎุงุฑุฌ ุงูุตูุฏูู. ุงุชุตู ุจูุง ุฅุฐุง ููุช ุชุฑูุฏ ูุฐู ุงูููุฒุฉ.*

### ุงููุตูุต ุงูุจุนูุฏุฉ: ุงุณุชุฎุฏุงู ุงููุตูุต ุงูููุฌูุฏุฉ ุนูู GitHub

*ูู ูุชู ุชุญุฏูุฏ ูุง ุฅุฐุง ูุงูุช ุงูููุฒุฉ ูุทููุจุฉ. ุงุชุตู ุจูุง ุฅุฐุง ููุช ุชุฑูุฏ ูุฐู ุงูููุฒุฉ.*