# ุงูุชุนุงูู ูุน ุงูููุงุฐุฌ ุงููุจูุฑุฉ ููุงุณุชูุชุงุฌ

ูู ุฃูุจุฑ ุงูุชุทูุฑุงุช ุงูุชู ุชููุฑูุง ููุชุจุฉ ๐ค Accelerate ูู ููููู [ุงุณุชูุชุงุฌ ุงูููุงุฐุฌ ุงููุจูุฑุฉ](../concept_guides/big_model_inference) ุญูุซ ููููู ุฅุฌุฑุงุก ุงูุงุณุชูุชุงุฌ ุนูู ุงูููุงุฐุฌ ุงูุชู ูุง ูููู ุฃู ุชูุงุณุจ ููููุง ุจุทุงูุฉ ุงูุฑุณููุงุช ุงูุฎุงุตุฉ ุจู.

ุณูุชู ุชูุณูู ูุฐุง ุงูุจุฑูุงูุฌ ุงูุชุนูููู ุฅูู ุฌุฒุฃูู ูุธูุฑุงู ููููุฉ ุงุณุชุฎุฏุงู ูู ูู ๐ค Accelerate ู ๐ค Transformers (ูุณุชูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุงูุฃุนูู) ููุงุณุชูุงุฏุฉ ูู ูุฐู ุงูููุฑุฉ.

## ุงุณุชุฎุฏุงู ๐ค Accelerate

ุจุงููุณุจุฉ ููุฐู ุงูุจุฑุงูุฌ ุงูุชุนููููุฉุ ุณููุชุฑุถ ุณูุฑ ุนูู ูููุฐุฌู ูุชุญููู ูููุฐุฌู ุจุญูุซ:

```py
import torch

my_model = ModelClass(...)
state_dict = torch.load(checkpoint_file)
my_model.load_state_dict(state_dict)
```

ูุงุญุธ ุฃููุง ููุชุฑุถ ููุง ุฃู `ModelClass` ูู ูููุฐุฌ ูุดุบู ุฐุงูุฑุฉ ุจุทุงูุฉ ุงูููุฏูู ุฃูุซุฑ ููุง ูููู ุฃู ููุงุณุจ ุฌูุงุฒู (ุณูุงุก ูุงู `mps` ุฃู `cuda`).

ุงูุฎุทูุฉ ุงูุฃููู ูู ุฅูุดุงุก ูููุฐุฌ ูุงุฑุบ ูู ูุดุบู ุฃู ุฐุงูุฑุฉ RAM ุจุงุณุชุฎุฏุงู ูุฏูุฑ ุณูุงู [`init_empty_weights`]:

```py
from accelerate import init_empty_weights
with init_empty_weights():
    my_model = ModelClass(...)
```

ูุน ูุฐุงุ ูุฅู `my_model` ุญุงูููุง "ุจุฏูู ูุนููุงุช"ุ ูุจุงูุชุงูู ูุชุฑู ุจุตูุฉ ุฃุตุบุฑ ููุง ูุฏ ูุญุตู ุนููู ุงููุฑุก ุนุงุฏุฉู ุนู ุทุฑูู ุงูุชุญููู ูุจุงุดุฑุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ.

ุจุนุฏ ุฐููุ ูุญุชุงุฌ ุฅูู ุชุญููู ุงูุฃูุฒุงู ูู ูููุฐุฌูุง ุญุชู ูุชููู ูู ุฅุฌุฑุงุก ุงูุงุณุชุฏูุงู.

ููููุงู ุจุฐููุ ุณูุณุชุฎุฏู [`load_checkpoint_and_dispatch`]ุ ูุงูุฐู ููุง ููุญู ุงูุงุณูุ ุณูููู ุจุชุญููู ููุทุฉ ุชูุชูุด ุฏุงุฎู ูููุฐุฌู ุงููุงุฑุบ ูุฅุฑุณุงู ุงูุฃูุฒุงู ููู ุทุจูุฉ ุนุจุฑ ุฌููุน ุงูุฃุฌูุฒุฉ ุงููุชููุฑุฉ ูุฏูู (GPU/MPS ูุฐุงูุฑุฉ CPU RAM).

ููุชุญุฏูุฏ ููููุฉ ุฅุฌุฑุงุก ูุฐุง "ุงูุฅุฑุณุงู"ุ ุนุงุฏุฉู ูุง ูููู ุชุญุฏูุฏ `device_map="auto"` ูุงูููุง ูุฃู ๐ค Accelerate
ุณูุญุงูู ููุก ุฌููุน ุงููุณุงุญุฉ ูู ูุญุฏุฉ (ูุญุฏุงุช) ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฎุงุตุฉ ุจูุ ุซู ุชุญููููุง ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉุ ูุฃุฎูุฑุงู ุฅุฐุง ูู ุชูู ููุงู ุฐุงูุฑุฉ RAM ูุงููุฉุ ูุณูุชู ุชุญููููุง ุฅูู ุงููุฑุต (ุฃุจุทุฃ ุฎูุงุฑ).

<Tip>

ููุญุตูู ุนูู ูุฒูุฏ ูู ุงูุชูุงุตูู ุญูู ุชุตููู ุฎุฑูุทุฉ ุงูุฃุฌูุฒุฉ ุงูุฎุงุตุฉ ุจูุ ุฑุงุฌุน ูุฐุง ุงููุณู ูู [ุฏููู ุงูููุงููู](../concept_guides/big_model_inference#designing-a-device-map)

</Tip>

ุงูุธุฑ ุงููุซุงู ุฃุฏูุงู:

```py
from accelerate import load_checkpoint_and_dispatch

model = load_checkpoint_and_dispatch(
    model, checkpoint=checkpoint_file, device_map="auto"
)
```

<Tip>

ุฅุฐุง ูุงูุช ููุงู "ูุทุน" ูุนููุฉ ูู ุงูุทุจูุงุช ุงูุชู ูุง ูุฌุจ ุชูุณูููุงุ ูููููู ุชูุฑูุฑูุง ุนูู ุฃููุง `no_split_module_classes`. ุงูุฑุฃ ุงููุฒูุฏ ุนููุง [ููุง](../concept_guides/big_model_inference#loading-weights)

</Tip>

<Tip>

ุฃูุถูุง ูุชูููุฑ ุงูุฐุงูุฑุฉ (ูุซู ุฅุฐุง ูู ูุชู ุงุญุชูุงุก `state_dict` ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู)ุ ูููู ุชูุณูู ุฃูุฒุงู ุงููููุฐุฌ ูุชูุณูููุง ุฅูู ุนุฏุฉ ูููุงุช ููุงุท ุชูุชูุด. ุงูุฑุฃ ุงููุฒูุฏ ุนููุง [ููุง](../concept_guides/big_model_inference#sharded-checkpoints)

</Tip>

ุงูุขู ุจุนุฏ ุฃู ุชู ุฅุฑุณุงู ุงููููุฐุฌ ุจุงููุงููุ ููููู ุฅุฌุฑุงุก ุงูุงุณุชุฏูุงู ูุงููุนุชุงุฏ ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ:

```py
input = torch.randn(2,3)
input = input.to("cuda")
output = model(input)
```

ูุง ุณูุญุฏุซ ุงูุขู ูู ุฃูู ูู ูู ูุฑุฉ ูุชู ูููุง ุชูุฑูุฑ ุงูุฅุฏุฎุงู ุนุจุฑ ุทุจูุฉุ ูุฅูู ูุชู ุฅุฑุณุงูู ูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (ุฃู ุงููุฑุต ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช)ุ ููุชู ุญุณุงุจ ุงูุฅุฎุฑุงุฌุ ุซู ูุชู ุณุญุจ ุงูุทุจูุฉ ูุฑุฉ ุฃุฎุฑู ูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุงูุนูุฏุฉ ุฅูู ุงูุฎุท. ูู ุญูู ุฃู ูุฐุง ูุถูู ุจุนุถ ุงููููุงุช ุงูุนุงูุฉ ููุงุณุชุฏูุงู ุงูุฐู ูุชู ุฅุฌุฑุงุคูุ ูู ุฎูุงู ูุฐู ุงูุทุฑููุฉ ูู ุงููููู ุชุดุบูู **ุฃู ุญุฌู ูููุฐุฌ** ุนูู ูุธุงููุ ุทุงููุง ุฃู ุฃูุจุฑ ุทุจูุฉ ูุงุฏุฑุฉ ุนูู ุงุญุชูุงุก ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฎุงุตุฉ ุจู.

<Tip>

ูููู ุงุณุชุฎุฏุงู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงููุชุนุฏุฏุฉุ ูููู ูุฐุง ูุนุชุจุฑ "ุชูุงุฒู ุงูููุงุฐุฌ" ููุชูุฌุฉ ูุฐููุ ุณุชููู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุงุญุฏุฉ ููุท ูุดุทุฉ ูู ุฃู ููุชุ ูู ุงูุชุธุงุฑ ุงุณุชูุงู ุงูุฅุฎุฑุงุฌ ูู ุงููุญุฏุฉ ุงูุณุงุจูุฉ. ูุฌุจ ุนููู ุชุดุบูู ุงูุจุฑูุงูุฌ ุงููุตู ุงูุฎุงุต ุจู ุจุดูู ุทุจูุนู ูุน `python`
ูููุณ ููุงู ุญุงุฌุฉ ุฅูู `torchrun`ุ `accelerate launch`ุ ุฅูุฎ.

</Tip>

ููุญุตูู ุนูู ุชูุซูู ูุฑุฆู ููุฐุงุ ุชุญูู ูู ุงูุฑุณูู ุงููุชุญุฑูุฉ ุฃุฏูุงู:

<Youtube id="MWCSGj9jEAo" />

### ูุซุงู ูุงูู

ูููุง ููู ุงููุซุงู ุงููุงูู ุงูุฐู ููุถุญ ูุง ูููุง ุจู ุฃุนูุงู:

```py
import torch
from accelerate import init_empty_weights, load_checkpoint_and_dispatch

with init_empty_weights():
model = MyModel(...)

model = load_checkpoint_and_dispatch(
    model, checkpoint=checkpoint_file, device_map="auto"
)

input = torch.randn(2,3)
input = input.to("cuda")
output = model(input)
```

## ุงุณุชุฎุฏุงู ๐ค Transformers ู ๐ค Diffusers ูููุชุจุงุช ุงููุตุงุฏุฑ ุงูููุชูุญุฉ ุงูุฃุฎุฑู ูู ๐ค

ุชุชุถูู ุงูููุชุจุงุช ุงูุชู ุชุฏุนู ุงุณุชูุชุงุฌ ุงูููุงุฐุฌ ุงููุจูุฑุฉ ูู ๐ค Accelerate ูู ุงูููุทู ุงูุณุงุจู ูู ุจุฑุงูุฌูุง `from_pretrained` ุงูุจูุงุฆูุฉ.

ุชุนูู ูุฐู ุงูุจุฑุงูุฌ ูู ุฎูุงู ุชุญุฏูุฏ ุณูุณูุฉ ุชูุซู ุงููููุฐุฌ ุงูุฐู ุณูุชู ุชูุฒููู ูู [๐ค Hub](https://hf.co/models) ุซู ุงูุฅุดุงุฑุฉ ุฅูู `device_map="auto"` ุฅูู ุฌุงูุจ ุจุนุถ ุงููุนููุงุช ุงูุฅุถุงููุฉ.

ููุซุงู ููุฌุฒุ ุณูููู ูุธุฑุฉ ุนูู ุงุณุชุฎุฏุงู `transformers` ูุชุญููู ูููุฐุฌ T0pp ุงูุฎุงุต ุจู Big Science.

```py
from transformers import AutoModelForSeq2SeqLM

model = AutoModelForSeq2SeqLM.from_pretrained("bigscience/T0pp", device_map="auto")
```

ุจุนุฏ ุชุญููู ุงููููุฐุฌุ ูุชู ุชูููุฐ ุงูุฎุทูุงุช ุงูุฃูููุฉ ูู ูุจู ูุฅุนุฏุงุฏ ุงููููุฐุฌ ููุฏ ุชู ุชูููุฐูุง ุฌููุนูุงุ ูุงููููุฐุฌ ุฌุงูุฒ ุชูุงููุง ููุงุณุชูุงุฏุฉ ูู ุฌููุน ุงูููุงุฑุฏ ุงูููุฌูุฏุฉ ูู ุฌูุงุฒู. ูู ุฎูุงู ูุฐู ุงูุจุฑุงูุฌ ุงูุจูุงุฆูุฉุ ููููู ุฃูุถูุง ุชูููุฑ *ุงููุฒูุฏ* ูู ุงูุฐุงูุฑุฉ ุนู ุทุฑูู
ุชุญุฏูุฏ ุงูุฏูุฉ ุงูุชู ูุชู ุชุญููู ุงููููุฐุฌ ุจูุง ุฃูุถูุงุ ูู ุฎูุงู ูุนููุฉ `torch_dtype`ุ ูุซู:

```py
from transformers import AutoModelForSeq2SeqLM

model = AutoModelForSeq2SeqLM.from_pretrained("bigscience/T0pp", device_map="auto", torch_dtype=torch.float16)
```

ููุนุฑูุฉ ุงููุฒูุฏ ุญูู ูุฐุง ุงูููุถูุนุ ุฑุงุฌุน ูุซุงุฆู ๐ค Transformers ุงููุชููุฑุฉ [ููุง](https://huggingface.co/docs/transformers/main/en/main_classes/model#large-model-loading).

## ุฅูู ุฃูู ุชุฐูุจ ูู ููุง

ููุญุตูู ุนูู ูุธุฑุฉ ุฃูุซุฑ ุชูุตููุงู ุนูู ุงุณุชูุชุงุฌ ุงูููุงุฐุฌ ุงููุจูุฑุฉุ ุชุฃูุฏ ูู ูุฑุงุฌุนุฉ [ุงูุฏููู ุงูููุงูููู ุญููู](../concept_guides/big_model_inference)