# ุงูุชุนุงูู ูุน ุงูููุงุฐุฌ ุงูุถุฎูุฉ ููุชูุจุค 

ุนูุฏ ุชุญููู ูููุฐุฌ ููุฏุฑุจ ูุณุจููุง ูู ุจุงู ุชูุฑุดุ ุชููู ุณูุฑ ุงูุนูู ุงููุนุชุงุฏุฉ ุนูู ุงููุญู ุงูุชุงูู:

```py
import torch

my_model = ModelClass(...)
state_dict = torch.load(checkpoint_file)
my_model.load_state_dict(state_dict)
```

ูุจูุบุฉ ุจุณูุทุฉุ ุชููู ูุฐู ุงูุฎุทูุงุช ูุงูุชุงูู:

1. ุฅูุดุงุก ุงููููุฐุฌ ูุน ุฃูุฒุงู ููููุฃุฉ ุจุดูู ุนุดูุงุฆู.
2. ุชุญููู ุฃูุฒุงู ุงููููุฐุฌ (ูู ูุงููุณ ููุณูู ุนุงุฏุฉู "ูุงููุณ ุงูุญุงูุฉ") ูู ุงููุฑุต.
3. ุชุญููู ูุฐู ุงูุฃูุฒุงู ุฏุงุฎู ุงููููุฐุฌ.

ูู ุญูู ุฃู ูุฐุง ูุนูู ุจุดูู ุฌูุฏ ุฌุฏูุง ูุน ุงูููุงุฐุฌ ุฐุงุช ุงูุญุฌู ุงูุนุงุฏูุ ูุฅู ุณูุฑ ุงูุนูู ูุฐู ููุง ุจุนุถ ุงููููุฏ ุงููุงุถุญุฉ ุนูุฏูุง ูุชุนุงูู ูุน ูููุฐุฌ ุถุฎู: ูู ุงูุฎุทูุฉ 1ุ ูููู ุจุชุญููู ูุณุฎุฉ ูุงููุฉ ูู ุงููููุฐุฌ ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆูุ ูููุถู ุจุนุถ ุงูููุช ูู ุชููุฆุฉ ุงูุฃูุฒุงู ุจุดูู ุนุดูุงุฆู (ูุงูุชู ุณูุชู ุงูุชุฎูุต ูููุง ูู ุงูุฎุทูุฉ 3). ูู ุงูุฎุทูุฉ 2ุ ูููู ุจุชุญููู ูุณุฎุฉ ูุงููุฉ ุฃุฎุฑู ูู ุงููููุฐุฌ ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆูุ ูุน ุงูุฃูุฒุงู ุงูููุฏุฑุจุฉ ูุณุจููุง. ุฅุฐุง ููุช ุชููู ุจุชุญููู ูููุฐุฌ ุจู 6 ูููุงุฑุงุช ูู ุงููุนููุงุชุ ููุฐุง ูุนูู ุฃูู ุณุชุญุชุงุฌ ุฅูู 24 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ููู ูุณุฎุฉ ูู ุงููููุฐุฌุ ุฃู ูุง ูุฌููุนู 48 ุฌูุฌุงุจุงูุช (ูุตููุง ูุชุญููู ุงููููุฐุฌ ูู FP16).

<Tip warning={true}>
ูุฐุง ุงูู API ุฌุฏูุฏ ุชูุงููุง ููุง ูุฒุงู ูู ูุฑุญูุชู ุงูุชุฌุฑูุจูุฉ. ูู ุญูู ุฃููุง ูุณุนู ุฌุงูุฏูู ูุชูููุฑ ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ูุณุชูุฑุฉุ ููู ุงููููู ุฃู ุชุชุบูุฑ ุจุนุถ ุงูุฃุฌุฒุงุก ุงูุตุบูุฑุฉ ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช ุงูุนุงูุฉ ูู ุงููุณุชูุจู.
</Tip>

## ููู ุชุนูู ุงูุนูููุฉ: ูุธุฑุฉ ุนุงูุฉ ุณุฑูุนุฉ

<Youtube id="MWCSGj9jEAo" />

## ููู ุชุนูู ุงูุนูููุฉ: ุงูุนูู ูุน ุงูููุฏ

### ุฅูุดุงุก ูููุฐุฌ ูุงุฑุบ

ุฃูู ุฃุฏุงุฉ ููุฏููุง ๐ค Accelerate ูููุณุงุนุฏุฉ ูู ุงูุชุนุงูู ูุน ุงูููุงุฐุฌ ุงูุถุฎูุฉ ูู ูุฏูุฑ ุณูุงู [`init_empty_weights`] ุงูุฐู ูุณุงุนุฏู ุนูู ุชููุฆุฉ ูููุฐุฌ ุจุฏูู ุงุณุชุฎุฏุงู ุฃู ุฐุงูุฑุฉ ูุตูู ุนุดูุงุฆู ุจุญูุซ ูููู ุชูููุฐ ุงูุฎุทูุฉ 1 ุนูู ููุงุฐุฌ ุฐุงุช ุฃุญุฌุงู ูุฎุชููุฉ. ุฅููู ููููุฉ ุนููู:

```py
from accelerate import init_empty_weights

with init_empty_weights():
my_model = ModelClass(...)
```

ุนูู ุณุจูู ุงููุซุงู:

```py
with init_empty_weights():
model = nn.Sequential(*[nn.Linear(10000, 10000) for _ in range(1000)])
```

ูุชู ุชููุฆุฉ ูููุฐุฌ ูุงุฑุบ ุจุฃูุซุฑ ุจูููู ูู 100 ุจูููู ูู ุงููุนููุงุช. ููู ุงูุฎูููุฉุ ูุนุชูุฏ ูุฐุง ุนูู ุงูุฌูุงุฒ ุงูููุชุง ุงูุฐู ุชู ุชูุฏููู ูู PyTorch 1.9. ุฃุซูุงุก ุงูุชููุฆุฉ ูู ุฅุทุงุฑ ูุฏูุฑ ุงูุณูุงูุ ูุชู ููู ูู ูุนููุฉ ูุชู ุฅูุดุงุคูุง ุนูู ุงูููุฑ ุฅูู ูุฐุง ุงูุฌูุงุฒ.

<Tip warning={true}>
ูุง ููููู ููู ูููุฐุฌ ุชูุช ุชููุฆุชู ุจูุฐู ุงูุทุฑููุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุฃู ุฅูู ุฌูุงุฒ ุขุฎุฑ ูุจุงุดุฑุฉูุ ูุฃูู ูุง ูุญุชูู ุนูู ุฃู ุจูุงูุงุช. ููู ุงููุญุชูู ุฃูุถูุง ุฃู ุชูุดู ุนูููุฉ ุงูุชูุฑูุฑ ููุฃูุงู ูุน ูุฐุง ุงููููุฐุฌ ุงููุงุฑุบุ ุญูุซ ุฃู ุงูุฌูุงุฒ ุงูููุชุง ูุง ูุฏุนู ุฌููุน ุงูุนูููุงุช.
</Tip>

### ููุงุท ุงูุชูุชูุด ุงููุฌุฒุฃุฉ

ูู ุงููููู ุฃู ูููู ูููุฐุฌู ูุจูุฑูุง ุฌุฏูุง ูุฏุฑุฌุฉ ุฃู ุงููุณุฎุฉ ุงููุงุญุฏุฉ ูู ุชูุงุณุจ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู. ูุฐุง ูุง ูุนูู ุฃูู ูุง ูููู ุชุญูููู: ุฅุฐุง ูุงู ูุฏูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุงุญุฏุฉ ุฃู ุฃูุซุฑุ ูููุงู ุงููุฒูุฏ ูู ุงูุฐุงูุฑุฉ ุงููุชุงุญุฉ ูุชุฎุฒูู ูููุฐุฌู. ูู ูุฐู ุงูุญุงูุฉุ ูู ุงูุฃูุถู ุฃู ูููู ููุทุฉ ุชูุชูุด ุงูุฎุงุตุฉ ุจู ููุณูุฉ ุฅูู ุนุฏุฉ ูููุงุช ุฃุตุบุฑ ููุทูู ุนูููุง ุดุธุงูุง ููุทุฉ ุงูุชูุชูุด.

ุณูููู ๐ค Accelerate ุจุงูุชุนุงูู ูุน ููุงุท ุงูุชูุชูุด ุงููุฌุฒุฃุฉ ุทุงููุง ุฃูู ุชุชุจุน ุงูุชูุณูู ุงูุชุงูู: ูุฌุจ ุฃู ุชููู ููุทุฉ ุงูุชูุชูุด ุงูุฎุงุตุฉ ุจู ูู ูุฌูุฏุ ูุน ุนุฏุฉ ูููุงุช ุชุญุชูู ุนูู ููุงููุณ ุงูุญุงูุฉ ุงูุฌุฒุฆูุฉุ ููุฌุจ ุฃู ูููู ููุงู ููุฑุณ ุจุชูุณูู JSON ูุญุชูู ุนูู ูุงููุณ ูููู ุจุชุนููู ุฃุณูุงุก ุงููุนููุงุช ุฅูู ุงูููู ุงูุฐู ูุญุชูู ุนูู ุฃูุฒุงููุง. ููููู ุจุณูููุฉ ุชุฌุฒุฆุฉ ูููุฐุฌู ุจุงุณุชุฎุฏุงู [`~Accelerator.save_model`]. ุนูู ุณุจูู ุงููุซุงูุ ูููู ุฃู ูุญุชูู ุงููุฌูุฏ ุนูู ูุง ููู:

```bash
first_state_dict.bin
index.json
second_state_dict.bin
```

ูุน ููู index.json ูู ุงูููู ุงูุชุงูู:

```
{
"linear1.weight": "first_state_dict.bin",
"linear1.bias": "first_state_dict.bin",
"linear2.weight": "second_state_dict.bin",
"linear2.bias": "second_state_dict.bin"
}
```

ู `first_state_dict.bin` ูุญุชูู ุนูู ุงูุฃูุฒุงู ูู `"linear1.weight"` ู `"linear1.bias"`ุ ู `second_state_dict.bin` ูุญุชูู ุนูู ุงูุฃูุฒุงู ูู `"linear2.weight"` ู `"linear2.bias"`

### ุชุญููู ุงูุฃูุฒุงู

ุชูุฏู ๐ค Accelerate ุฃูุถูุง ูุธููุฉ [`load_checkpoint_and_dispatch`]ุ ูุงูุชู ุณุชุณูุญ ูู ุจุชุญููู ููุทุฉ ุชูุชูุด ุฏุงุฎู ูููุฐุฌู ุงููุงุฑุบ. ูุฏุนู ูุฐุง ููุงุท ุงูุชูุชูุด ุงููุงููุฉ (ููู ูุงุญุฏ ูุญุชูู ุนูู ูุงููุณ ุงูุญุงูุฉ ุจุงููุงูู) ููุฐูู ููุงุท ุงูุชูุชูุด ุงููุฌุฒุฃุฉ. ููุง ุฃูู ุณููุฒุน ูุฐู ุงูุฃูุฒุงู ุชููุงุฆููุง ุนุจุฑ ุงูุฃุฌูุฒุฉ ุงููุชููุฑุฉ ูุฏูู (ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุชุ ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ููุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ)ุ ูุฐุง ุฅุฐุง ููุช ุชููู ุจุชุญููู ููุทุฉ ุชูุชูุด ูุฌุฒุฃุฉุ ูุณูููู ุงูุญุฏ ุงูุฃูุตู ูุงุณุชุฎุฏุงู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ูู ุญุฌู ุฃูุจุฑ ุดุธูุฉ.

ุฅุฐุง ููุช ุชุฑูุฏ ุงุณุชุฎุฏุงู ุงูุงุณุชุฏูุงู ุจูููุฐุฌ ูุจูุฑ ูุน ููุงุฐุฌ ๐ค Transformersุ ูุฑุงุฌุน ูุฐู [ุงููุซุงุฆู](https://huggingface.co/docs/transformers/main/en/main_classes/model#large-model-loading).

ููุฐุง ูููููุง ุงุณุชุฎุฏุงู ูุฐุง ูุชุญููู ูููุฐุฌ [GPT2-1.5B](https://huggingface.co/marcsun13/gpt2-xl-linear-sharded).

ุฏุนูุง ูููู ุจุชูุฒูู ุงูุฅุตุฏุงุฑ ุงููุฌุฒุฃ ูู ูุฐุง ุงููููุฐุฌ.

```bash
pip install huggingface_hub
```

```py
from huggingface_hub import snapshot_download
checkpoint = "marcsun13/gpt2-xl-linear-sharded"
weights_location = snapshot_download(repo_id=checkpoint)
```

ูุชููุฆุฉ ุงููููุฐุฌุ ุณูุณุชุฎุฏู ููุชุจุฉ minGPT.

```bash
git clone https://github.com/karpathy/minGPT.git
pip install minGPT/
```

```py
from accelerate import init_empty_weights
from mingpt.model import GPT

model_config = GPT.get_default_config()
model_config.model_type = 'gpt2-xl'
model_config.vocab_size = 50257
model_config.block_size = 1024

with init_empty_weights():
model = GPT(model_config)
```

ุจุนุฏ ุฐููุ ูู ุจุชุญููู ููุทุฉ ุงูุชูุชูุด ุงูุชู ูููุง ุจุชูุฒูููุง ููุชู ุจุงุณุชุฎุฏุงู:

```py
from accelerate import load_checkpoint_and_dispatch

model = load_checkpoint_and_dispatch(
model, checkpoint=weights_location, device_map="auto", no_split_module_classes=['Block']
)
```

ูู ุฎูุงู ุชูุฑูุฑ `device_map="auto"`ุ ูุทูุจ ูู ๐ค Accelerate ุฃู ูุญุฏุฏ ุชููุงุฆููุง ุงูููุงู ุงูุฐู ูุฌุจ ูุถุน ูู ุทุจูุฉ ูู ุงููููุฐุฌ ููู ุงุนุชูุงุฏูุง ุนูู ุงูููุงุฑุฏ ุงููุชุงุญุฉ:

- ุฃููุงูุ ูุณุชุฎุฏู ุงููุณุงุญุฉ ุงููุตูู ุงููุชุงุญุฉ ูู ูุญุฏุฉ (ูุญุฏุงุช) ูุนุงูุฌุฉ ุงูุฑุณููุงุช.
- ุฅุฐุง ููุง ูุง ูุฒุงู ุจุญุงุฌุฉ ุฅูู ูุณุงุญุฉุ ูููู ุจุชุฎุฒูู ุงูุฃูุฒุงู ุงููุชุจููุฉ ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ.
- ุฅุฐุง ูู ุชูู ููุงู ุฐุงูุฑุฉ ูุตูู ุนุดูุงุฆู ูุงููุฉุ ูููู ุจุชุฎุฒูู ุงูุฃูุฒุงู ุงููุชุจููุฉ ุนูู ุงููุฑุต ุงูุตูุจ ูููุชุฑ ุฐู ุฎุฑูุทุฉ ุฐุงูุฑุฉ.

#### `no_split_module_classes`

ุณูุคุดุฑ ูุฐุง ุงููุนุงูู ุนูู ุฃู ุจุนุถ ุงููุญุฏุงุช ุงูููุทูุฉ ุงูุชู ุชุญูู ุงูุงุณู `"Block"` ูุฌุจ ุฃูุง ูุชู ุชูุณูููุง ุนุจุฑ ุฃุฌูุฒุฉ ูุฎุชููุฉ. ูุฌุจ ุนููู ููุง ุชุนููู ุฌููุน ุงููุชู ุงูุชู ุชุชุถูู ููุนูุง ูุง ูู ุงูุงุชุตุงู ุงููุชุจูู.

#### `device_map`

ููููู ุฑุคูุฉ `device_map` ุงูุฐู ุงุฎุชุงุฑู ๐ค Accelerate ุจุงููุตูู ุฅูู ุงูุณูุฉ `hf_device_map` ูููููุฐุฌ ุงูุฎุงุต ุจู:

```py
model.hf_device_map
```

```python out
{'transformer.wte': 0,
'transformer.wpe': 0,
'transformer.drop': 0,
'transformer.h.0': 0,
...
'transformer.h.21': 0,
'transformer.h.22': 1,
'transformer.h.23': 1,
'transformer.h.24': 1,
...
'transformer.h.47': 1,
'transformer.ln_f': 1,
'lm_head': 1}
```

ูู ุงููููู ุชูุงููุง ุฅูุดุงุก ุฎุฑูุทุฉ ุฃุฌูุฒุชู ุงูุฎุงุตุฉ ูุทุจูุงุช ุงููููุฐุฌ ูุงุณุชุฎุฏุงููุง ุฃูุถูุงุ ูุชุญุฏูุฏ ุฌูุงุฒ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุงูุฐู ุณูุชู ุงุณุชุฎุฏุงูู (ุฑูู)ุ ุฃู `"cpu"`ุ ุฃู `"disk"` ูุชูุฑูุฑู:

```python
device_map = {
"transformer.wte": "cpu"ุ
"transformer.wpe": 0ุ
"transformer.drop": "cpu"ุ
"transformer.h.0": "disk"
}

model = load_checkpoint_and_dispatch(
modelุ checkpoint=weights_locationุ device_map=device_map
)
```

### ุชุดุบูู ุงููููุฐุฌ

ุงูุขู ุจุนุฏ ุฃู ูููุง ุจุฐููุ ููุฌุฏ ูููุฐุฌูุง ุนุจุฑ ุนุฏุฉ ุฃุฌูุฒุฉุ ูุฑุจูุง ุงููุฑุต ุงูุตูุจ. ููู ูุง ูุฒุงู ูููู ุงุณุชุฎุฏุงูู ููููุฐุฌ PyTorch ุนุงุฏู:

```py
from mingpt.bpe import BPETokenizer
tokenizer = BPETokenizer()
inputs = tokenizer("Hello, my name is").to(0)

outputs = model.generate(x1, max_new_tokens=10, do_sample=False)[0]
tokenizer.decode(outputs.cpu().squeeze())
```

ูู ุงูุฎูููุฉุ ุฃุถุงู ๐ค Accelerate ุฎุทุงูุงุช ุฅูู ุงููููุฐุฌุ ุจุญูุซ:

- ูู ูู ุทุจูุฉุ ูุชู ูุถุน ุงููุฏุฎูุงุช ุนูู ุงูุฌูุงุฒ ุงูุตุญูุญ (ูุฐุง ุญุชู ุฅุฐุง ูุงู ูููุฐุฌู ููุชุดุฑูุง ุนุจุฑ ุนุฏุฉ ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุชุ ูุฅูู ูุนูู)
- ุจุงููุณุจุฉ ููุฃูุฒุงู ุงูุชู ุชู ููููุง ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉุ ูุชู ูุถุนูุง ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุจู ุงูุชูุฑูุฑ ููุฃูุงู ูุชูุธูููุง ุจุนุฏ ุฐูู ูุจุงุดุฑุฉ
- ุจุงููุณุจุฉ ููุฃูุฒุงู ุงูุชู ุชู ููููุง ุฅูู ุงููุฑุต ุงูุตูุจุ ูุชู ุชุญููููุง ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุซู ูุถุนูุง ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช ูุจู ุงูุชูุฑูุฑ ููุฃูุงู ูุชูุธูููุง ุจุนุฏ ุฐูู ูุจุงุดุฑุฉ

ุจูุฐู ุงูุทุฑููุฉุ ูููู ุชุดุบูู ูููุฐุฌู ููุงุณุชุฏูุงู ุญุชู ุฅุฐุง ูู ููุงุณุจ ุฅุญุฏู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช ุฃู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ููุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ!

<Tip warning={true}>
ูุฏุนู ูุฐุง ููุท ุงูุงุณุชุฏูุงู ููููุฐุฌูุ ูููุณ ุงูุชุฏุฑูุจ. ูุญุฏุซ ูุนุธู ุงูุญุณุงุจ ุฎูู ุณูุงูุงุช `torch.no_grad()` ูุชุฌูุจ ุฅููุงู ุจุนุถ ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช ูุน ุงูุชูุดูุทุงุช ุงููุณูุทุฉ.
</Tip>
### ุชุตููู ุฎุฑูุทุฉ ุงูุฃุฌูุฒุฉ

ููููู ุงูุณูุงุญ ูู ๐ค Accelerate ุจูุนุงูุฌุฉ ุญุณุงุจ ุฎุฑูุทุฉ ุงูุฃุฌูุฒุฉ ูู ุฎูุงู ุชุนููู "device_map" ุฅูู ุฅุญุฏู ุงูุฎูุงุฑุงุช ุงููุฏุนููุฉ ("auto" ุฃู "balanced" ุฃู "balanced_low_0" ุฃู "sequential")ุ ุฃู ุฅูุดุงุก ุฎุฑูุทุฉ ุฎุงุตุฉ ุจู ุฅุฐุง ููุช ุชุฑูุฏ ูุฒูุฏูุง ูู ุงูุชุญูู ูู ุงูููุงู ุงูุฐู ูุฌุจ ุฃู ุชุฐูุจ ุฅููู ูู ุทุจูุฉ.

<Tip>
ููููู ุงุดุชูุงู ุฌููุน ุฃุญุฌุงู ุงููููุฐุฌ (ูุจุงูุชุงูู ุญุณุงุจ "device_map") ุนูู ูููุฐุฌ ููุฌูุฏ ุนูู ุฌูุงุฒ meta.
</Tip>

ุณุชูุชุฌ ุฌููุน ุงูุฎูุงุฑุงุช ููุณ ุงููุชูุฌุฉ ุนูุฏูุง ูุง ูููู ูุฏูู ุฐุงูุฑุฉ GPU ูุงููุฉ ูุงุณุชูุนุงุจ ุงููููุฐุฌ ุจุงููุงูู (ูุงูุฐู ูุชูุซู ูู ููุงุกูุฉ ูู ูุง ูููู ุนูู GPUุ ุซู ุชูุฑูุบ ุงูุฃูุฒุงู ุนูู CPU ุฃู ุญุชู ุนูู ุงููุฑุต ุฅุฐุง ูู ููู ููุงู ุฐุงูุฑุฉ RAM ูุงููุฉ).

ุนูุฏูุง ูููู ูุฏูู ุงููุฒูุฏ ูู ุฐุงูุฑุฉ GPU ุงููุชุงุญุฉ ุฃูุจุฑ ูู ุญุฌู ุงููููุฐุฌุ ูููู ุงููุฑู ุจูู ูู ุฎูุงุฑ ุนูู ุงููุญู ุงูุชุงูู:

- ููุณู ูู ูู "auto" ู"balanced" ุงููููุฐุฌ ุจุงูุชุณุงูู ุนูู ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงููุชุงุญุฉุ ููุง ูุชูุญ ูู ุงุณุชุฎุฏุงู ุญุฌู ุฏูุนุฉ ุฃูุจุฑ ูู 1.

- ููุณู "balanced_low_0" ุงููููุฐุฌ ุจุงูุชุณุงูู ุนูู ุฌููุน ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุจุงุณุชุซูุงุก ุงูุฃูููุ ููุง ูุถุน ุนูู GPU 0 ุฅูุง ูุง ูุง ููุงุณุจ ุงูุฃุฎุฑูุงุช. ูุฐุง ุงูุฎูุงุฑ ุฑุงุฆุน ุนูุฏูุง ุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู GPU 0 ููุนุงูุฌุฉ ุงููุฎุฑุฌุงุชุ ููุง ูู ุงูุญุงู ุนูุฏ ุงุณุชุฎุฏุงู ุฏุงูุฉ "generate" ูููุงุฐุฌ ุงููุญููุงุช.

- ุณูููู "sequential" ุจุชุฑููุจ ูุง ููููู ุนูู GPU 0ุ ุซู ุงูุงูุชูุงู ุฅูู GPU 1ุ ูููุฐุง (ูุฐูู ูู ูุณุชุฎุฏู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงูุฃุฎูุฑุฉ ุฅุฐุง ูู ููู ููุงู ุญุงุฌุฉ ูุฐูู).

<Tip>
ููุชุฌ ุฎูุงุฑุง "auto" ู"balanced" ููุณ ุงููุชุงุฆุฌ ุงูุขูุ ูููู ูุฏ ูุชุบูุฑ ุณููู "auto" ูู ุงููุณุชูุจู ุฅุฐุง ูุฌุฏูุง ุงุณุชุฑุงุชูุฌูุฉ ุฃูุซุฑ ููุทููุฉุ ูู ุญูู ุฃู "balanced" ุณุชุธู ูุณุชูุฑุฉ.
</Tip>

ุฃููุงูุ ูุงุญุธ ุฃูู ููููู ุชุญุฏูุฏ ุงูุฐุงูุฑุฉ ุงููุณุชุฎุฏูุฉ ุนูู ูู GPU ุจุงุณุชุฎุฏุงู ูุณูุท "max_memory" (ุงููุชุงุญ ูู ["infer_auto_device_map"] ููู ุฌููุน ุงูุฏูุงู ุงูุชู ุชุณุชุฎุฏูู). ุนูุฏ ุชุนููู "max_memory"ุ ูุฌุจ ุชูุฑูุฑ ูุงููุณ ูุญุชูู ุนูู ูุญุฏุฏุงุช ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU (ุนูู ุณุจูู ุงููุซุงู 0 ู1ุ ุฅูุฎ.) ูููุชุงุญ "cpu" ูุญุฏ RAM ุงูุฃูุตู ุงูุฐู ุชุฑูุฏ ุงุณุชุฎุฏุงูู ูุชูุฑูุบ CPU. ูููู ุฃู ุชููู ุงูููู ุฅูุง ุนุฏุฏ ุตุญูุญ (ุจุงูุจุงูุช) ุฃู ุณูุณูุฉ ูุตูุฉ ุชูุซู ุนุฏุฏูุง ูุน ูุญุฏุชูุ ูุซู "10GiB" ุฃู "10GB".

ูููุง ููู ูุซุงู ูุง ูุฑูุฏ ููู ุงุณุชุฎุฏุงู ุฃูุซุฑ ูู 10 ุฌูุฌุงุจุงูุช ุนูู ูู ูู ูุญุฏุชู ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ููุง ุฃูุซุฑ ูู 30 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู RAM ูููุฒู ุงููููุฐุฌ:

```python
from accelerate import infer_auto_device_map

device_map = infer_auto_device_map(my_model, max_memory={0: "10GiB", 1: "10GiB", "cpu": "30GiB"})
```

<Tip warning={true}>
ุนูุฏ ุญุฏูุซ ุงูุชุฎุตูุต ุงูุฃูู ูู PyTorchุ ูุฅูู ูุญููู ููู CUDA ุงูุชู ุชุณุชููู ุญูุงูู 1-2 ุฌูุฌุงุจุงูุช ูู ุงูุฐุงูุฑุฉ ุงุนุชูุงุฏูุง ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU. ูุฐููุ ูุฏูู ุฏุงุฆููุง ุฐุงูุฑุฉ ูุงุจูุฉ ููุงุณุชุฎุฏุงู ุฃูู ูู ุญุฌู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงููุนูู. ููุนุฑูุฉ ููุฏุงุฑ ุงูุฐุงูุฑุฉ ุงููุณุชุฎุฏูุฉ ุจุงููุนูุ ูู ุจุชุดุบูู "torch.ones(1).cuda()" ูุงูุธุฑ ุฅูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ.

ูุฐููุ ุนูุฏ ุฅูุดุงุก ุฎุฑุงุฆุท ุงูุฐุงูุฑุฉ ุจุงุณุชุฎุฏุงู "max_memory"ุ ุชุฃูุฏ ูู ุถุจุท ุงูุฐุงูุฑุฉ ุงููุชุงุญุฉ ููููุง ูุฐูู ูุชุฌูุจ ุฃุฎุทุงุก ุนุฏู ููุงูุฉ ุงูุฐุงูุฑุฉ.
</Tip>

ุจุงูุฅุถุงูุฉ ุฅูู ุฐููุ ุฅุฐุง ููุช ุชููู ุจุจุนุถ ุงูุนูููุงุช ุงูุฅุถุงููุฉ ูุน ุงููุฎุฑุฌุงุช ุฏูู ูุถุนูุง ูุฑุฉ ุฃุฎุฑู ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU (ุนูู ุณุจูู ุงููุซุงู ุฏุงุฎู ุทุฑููุฉ "generate" ูู ุงููุญููุงุช) ูุฅุฐุง ููุช ุจูุถุน ุงููุฏุฎูุงุช ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPUุ ูุณุชุณุชููู ุชูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงููุฒูุฏ ูู ุงูุฐุงูุฑุฉ ุฃูุซุฑ ูู ุบูุฑูุง (ุฏุงุฆููุง ูุง ูููู Accelerate ุจุฅุนุงุฏุฉ ุงูุฅุฎุฑุงุฌ ุฅูู ุฌูุงุฒ ุงูุฅุฏุฎุงู). ูุฐููุ ุฅุฐุง ููุช ุชุฑุบุจ ูู ุชุญุณูู ุญุฌู ุงูุฏูุนุฉ ุงูุฃูุตู ููุฏูู ุงูุนุฏูุฏ ูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPUุ ููู ุจุชุฎุตูุต ุฐุงูุฑุฉ ุฃูู ููุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงูุฃููู. ุนูู ุณุจูู ุงููุซุงูุ ูุน BLOOM-176B ุนูู 8x80 ุฅุนุฏุงุฏ A100ุ ูุฅู ุงูุฎุฑูุทุฉ ุงููุฑูุจุฉ ูู ุงููุซุงููุฉ ูู:

```python
max_memory = {0: "30GIB", 1: "46GIB", 2: "46GIB", 3: "46GIB", 4: "46GIB", 5: "46GIB", 6: "46GIB", 7: "46GIB"}
```

ููุง ุชุฑููุ ููุฏ ุฃุนุทููุง ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุงูู 7 ุงููุชุจููุฉ ~50% ูู ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU 0.

ุฅุฐุง ุงุฎุชุฑุช ุชุตููู "device_map" ุจููุณูุ ููุฌุจ ุฃู ูููู ูุงููุณูุง ุจููุงุชูุญ ุชููู ุฃุณูุงุก ุงููุญุฏุงุช ุงูููุทูุฉ ููููุฐุฌูุ ูุงูููู ูุญุฏุฏูุง ุตุงูุญูุง ููุฌูุงุฒ (ุนูู ุณุจูู ุงููุซุงูุ ุนุฏุฏ ุตุญูุญ ููุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU) ุฃู "cpu" ูุชูุฑูุบ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPUุ ุฃู "disk" ูุชูุฑูุบ ุงููุฑุต. ูุฌุจ ุฃู ุชุบุทู ุงูููุงุชูุญ ุงููููุฐุฌ ุจุงููุงููุ ุซู ููููู ุชุญุฏูุฏ ุฎุฑูุทุฉ ุงูุฌูุงุฒ ููุง ุชุฑูุฏ: ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ูุงู ููููุฐุฌู ูุชูุชุงู (ูููู "block1" ู"block2") ุชุญุชูู ูู ููููุง ุนูู ุซูุงุซ ุทุจูุงุช ุฎุทูุฉ (ูููู "linear1" ู"linear2" ู"linear3")ุ ูุฅู ุฎุฑูุทุฉ ุงูุฌูุงุฒ ุงูุตุงูุญุฉ ูููู ุฃู ุชููู:

```python
device_map = {"block1": 0, "block2": 1}
```

ููููู ุฃู ุชููู ุฎุฑูุทุฉ ุฃุฎุฑู ุตุงูุญุฉ ุนูู ุงููุญู ุงูุชุงูู:

```python
device_map = {"block1": 0, "block2.linear1": 0, "block2.linear2": 1, "block2.linear3": 1}
```

ูู ูุงุญูุฉ ุฃุฎุฑูุ ูุฅู ูุฐู ุงูุฎุฑูุทุฉ ุบูุฑ ุตุงูุญุฉ ูุฃููุง ูุง ุชุบุทู ุฌููุน ูุนููุงุช ุงููููุฐุฌ:

```python
device_map = {"block1": 0, "block2.linear1": 1, "block2.linear2": 1}
```

<Tip>
ูุชุญููู ุงูููุงุกุฉ ุงููุตููุ ุชุฃูุฏ ูู ุฃู ุฎุฑูุทุฉ ุงูุฌูุงุฒ ุชููู ุจูุถุน ุงููุนููุงุช ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุจุทุฑููุฉ ูุชุณูุณูุฉ (ุนูู ุณุจูู ุงููุซุงูุ ูุง ุชุถุน ุฃุญุฏ ุงูุฃูุฒุงู ุงูุฃููู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU 0ุ ุซู ุงูุฃูุฒุงู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU 1 ูุงููุฒู ุงูุฃุฎูุฑ ูุฑุฉ ุฃุฎุฑู ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU 0) ูุชุฌูุจ ุฅุฌุฑุงุก ุงูุนุฏูุฏ ูู ุนูููุงุช ููู ุงูุจูุงูุงุช ุจูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU.
</Tip>

## ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU ููุท

ุฅุฐุง ููุช ุชุฑูุฏ ุชูุฑูุบ ูููุฐุฌู ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPUุ ูููููู ุงุณุชุฎุฏุงู ["cpu_offload"]. ููุชูุฌุฉ ูุฐููุ ุณูุชู ุชูุฑูุบ ุฌููุน ูุนููุงุช ุงููููุฐุฌ ูุณูุชู ุงูุงุญุชูุงุธ ุจูุณุฎุฉ ูุงุญุฏุฉ ููุท ูู ุงููุงููุณ ุงูุญุงูุฉ ูููููุฐุฌ. ุฃุซูุงุก ุนูููุฉ ุงูุชูุฏููุ ุณูุชู ุงุณุชุฎุฑุงุฌ ุงููุนููุงุช ูู ูุงููุณ ุงูุญุงูุฉ ููุถุนูุง ุนูู ุฌูุงุฒ ุงูุชูููุฐ ูุชูุฑูุฑูุง ุญุณุจ ุงูุญุงุฌุฉุ ุซู ุชูุฑูุบูุง ูุฑุฉ ุฃุฎุฑู.

```python
cpu_offload(model, execution_device)
```

ููููู ุฃูุถูุง ุงุณุชุฎุฏุงู ["cpu_offload_with_hook"]. ุชููู ูุฐู ุงูุฏุงูุฉ ุจุชูุฑูุบ ูููุฐุฌ ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU ููุถุนู ูุฑุฉ ุฃุฎุฑู ุนูู ุฌูุงุฒ ุงูุชูููุฐ ุนูุฏ ุงูุชูููุฐ. ูุงููุฑู ุจูููุง ูุจูู ["cpu_offload"] ูู ุฃู ุงููููุฐุฌ ูุจูู ุนูู ุฌูุงุฒ ุงูุชูููุฐ ุจุนุฏ ุนูููุฉ ุงูุชูุฏูู ููุง ูุชู ุชูุฑูุบู ูุฑุฉ ุฃุฎุฑู ุฅูุง ุนูุฏ ุงุณุชุฏุนุงุก ุทุฑููุฉ "offload" ูู ุฎุทุงู "hook" ุงูุฐู ุชู ุฅุฑุฌุงุนู. ุนูุงูุฉ ุนูู ุฐููุ ูุฅู ["cpu_offload_with_hook"] ุฃูุซุฑ ููุงุกุฉ ููููู ุฃูู ุชูููุฑูุง ููุฐุงูุฑุฉ. ุฅูู ูููุฏ ูุฃูุงุจูุจ ุงูุชูุฌูู ุงูุชู ุชููู ุจุชุดุบูู ูููุฐุฌ ูู ุญููุฉ:

```python
model_1, hook_1 = cpu_offload_with_hook(model_1, execution_device)
model_2, hook_2 = cpu_offload_with_hook(model_2, execution_device, prev_module_hook=hook_1)
model_3, hook_3 = cpu_offload_with_hook(model_3, execution_device, prev_module_hook=hook_2)

hid_1 = model_1(input)
for i in range(50):
    # ูุชู ุชูุฑูุบ ุงููููุฐุฌ 1 ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU ูู ุงูุชูุฑุงุฑ ุงูุฃููุ ููุจูู ุงููููุฐุฌ 2 ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุทูุงู ูุฐู ุงูุญููุฉ.
    hid_2 = model_2(hid_1)
    # ูุชู ุชูุฑูุบ ุงููููุฐุฌ 2 ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU ูุจู ูุฐุง ุงูุชูุฏูู ูุจุงุดุฑุฉ.
    hid_3 = model_3(hid_3)

# ุจุงููุณุจุฉ ูููููุฐุฌ 3ุ ูุฌุจ ุงุณุชุฏุนุงุก ุทุฑููุฉ offload ููุฎุทุงู ูุฏูููุง.
hook_3.offload()
```

## ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุนูู ุงููุฑุต ููุท

ูุชูููุฐ ุชูุฑูุบ ุงููุฑุตุ ููููู ุงุณุชุฎุฏุงู ["disk_offload"]. ููุชูุฌุฉ ูุฐููุ ุณูุชู ุชูุฑูุบ ุฌููุน ูุนููุงุช ุงููููุฐุฌ ููุตูููุฉ ููุฏุงุฑุฉ ุจุงูุฐุงูุฑุฉ ูู ูุฌูุฏ ูุนูู. ุฃุซูุงุก ุนูููุฉ ุงูุชูุฏููุ ุณูุชู ุงููุตูู ุฅูู ุงููุนููุงุช ูู ูุฐุง ุงููุฌูุฏ ููุถุนูุง ุนูู ุฌูุงุฒ ุงูุชูููุฐ ุงูุฐู ูุชู ุชูุฑูุฑู ุญุณุจ ุงูุญุงุฌุฉุ ุซู ุชูุฑูุบูุง ูุฑุฉ ุฃุฎุฑู.

```python
disk_offload(model, offload_dir, execution_device)
```

## ุงููููุฏ ูุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ

ูุญู ุนูู ุฏุฑุงูุฉ ุจุงููููุฏ ุงูุญุงููุฉ ูู ูุงุฌูุฉ ุจุฑูุฌุฉ ุงูุชุทุจููุงุช API:

- ูุญุงูู ["infer_auto_device_map"] (ุฃู "device_map="auto"" ูู ["load_checkpoint_and_dispatch"]) ุฒูุงุฏุฉ ุฐุงูุฑุฉ GPU ูุฐุงูุฑุฉ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU ุงูุชู ูุฑุงูุง ูุชุงุญุฉ ุนูุฏ ุชูููุฐูุง. ูู ุญูู ุฃู PyTorch ุฌูุฏ ุฌุฏูุง ูู ุฅุฏุงุฑุฉ ุฐุงูุฑุฉ GPU ุจููุงุกุฉ (ูุฅุนุงุฏุชูุง ุนูุฏ ุนุฏู ุงูุญุงุฌุฉ ุฅูููุง)ุ ูุฅู ูุฐุง ูุง ููุทุจู ุชูุงููุง ูุน Python ูุฐุงูุฑุฉ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU. ูุฐููุ ูุฏ ุชููู ุฎุฑูุทุฉ ุงูุฌูุงุฒ ุงููุญุณูุจุฉ ุชููุงุฆููุง ููุซูุฉ ุฌุฏูุง ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU. ูู ุจููู ุจุนุถ ุงููุญุฏุงุช ุงูููุทูุฉ ุฅูู ุฌูุงุฒ ุงููุฑุต ุฅุฐุง ูุงุฌูุช ุชุนุทููุง ุจุณุจุจ ููุต ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู RAM.

- ูููู ["infer_auto_device_map"] (ุฃู "device_map="auto"" ูู ["load_checkpoint_and_dispatch"]) ุจุชุนููู ุงูุฃุฌูุฒุฉ ุจุดูู ูุชุณูุณู (ูุชุฌูุจ ููู ุงูุฃุดูุงุก ุฐูุงุจูุง ูุฅูุงุจูุง) ูุฐูู ุฅุฐุง ูุงูุช ุงูุทุจูุฉ ุงูุฃููู ุฃูุจุฑ ูู ุญุฌู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ูุฏููุ ูุณูุชู ูุถุน ูู ุดูุก ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU/ุงููุฑุต.

- ูุง ุชููู ุฏุงูุชุง ["load_checkpoint_and_dispatch"] ู["load_checkpoint_in_model"] ุจุฃู ูุญุต ูุณูุงูุฉ ูุงููุณ ุงูุญุงูุฉ state dict ุงูุฎุงุต ุจู ููุงุฑูุฉ ุจูููุฐุฌู ูู ุงูููุช ุงูุญุงูู (ุณูุชู ุฅุตูุงุญ ุฐูู ูู ุฅุตุฏุงุฑ ูุณุชูุจูู)ุ ูุฐูู ูุฏ ุชุญุตู ุนูู ุจุนุถ ุงูุฃุฎุทุงุก ุงูุบุฑูุจุฉ ุฅุฐุง ุญุงููุช ุชุญููู ููุทุฉ ุชูุชูุด ูุน ููุงุชูุญ ุบูุฑ ูุชุทุงุจูุฉ ุฃู ููููุฏุฉ.

- ุงููุชูุงุฒูุฉ ุงููููุฐุฌูุฉ ุงููุณุชุฎุฏูุฉ ุนูุฏูุง ูุชู ุชูุณูู ูููุฐุฌู ุนูู ุนุฏุฉ ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุบูุฑ ูุญุณููุฉุ ููุง ูุนูู ุฃู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ูุงุญุฏุฉ ุชุนูู ูู ููุช ูุงุญุฏ ุจูููุง ุชุธู ุงูุฃุฎุฑู ุฎุงููุฉ.

- ุนูุฏูุง ูุชู ุชูุฑูุบ ุงูุฃูุฒุงู ุนูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU/ุงููุฑุต ุงูุตูุจุ ูุง ููุฌุฏ ุงุณุชุจุงู (ุญุชู ุงูุขูุ ุณูุนูู ุนูู ุฐูู ููุฅุตุฏุงุฑุงุช ุงููุณุชูุจููุฉ) ููุง ูุนูู ุฃู ุงูุฃูุฒุงู ูุชู ูุถุนูุง ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช GPU ุนูุฏ ุงูุญุงุฌุฉ ูููุณ ูุจู ุฐูู.

- ูุฏ ูููู ุชูุฑูุบ ุงููุฑุต ุงูุตูุจ ุจุทูุฆูุง ุฌุฏูุง ุฅุฐุง ูู ููู ูุฏู ุงูุฃุฌูุฒุฉ ุงูุชู ุชุนูู ุนูููุง ุงุชุตุงู ุณุฑูุน ุจูู ุงููุฑุต ููุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ CPU (ูุซู ูุญุฏุงุช ุงูุฐุงูุฑุฉ ุงููููุถูุฉ NVMe).