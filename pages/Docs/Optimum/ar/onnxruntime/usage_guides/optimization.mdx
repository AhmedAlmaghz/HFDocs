# ุงูุชุญุณูู

ูููุฑ ๐ค Optimum ุญุฒูุฉ `optimum.onnxruntime` ุงูุชู ุชุชูุญ ูู ุชุทุจูู ุชุญุณูู ุงูุฑุณู ุงูุจูุงูู ุนูู ุงูุนุฏูุฏ ูู ุงูููุงุฐุฌ ุงููุณุชุถุงูุฉ ุนูู ๐ค hub ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุชุญุณูู ูููุฐุฌ [ONNX Runtime](https://github.com/microsoft/onnxruntime/tree/master/onnxruntime/python/tools/transformers).

## ุชุญุณูู ูููุฐุฌ ุฃุซูุงุก ุชุตุฏูุฑ ONNX

ูููู ุชุญุณูู ูููุฐุฌ ONNX ูุจุงุดุฑุฉ ุฃุซูุงุก ุชุตุฏูุฑ ONNX ุจุงุณุชุฎุฏุงู ูุงุฌูุฉ ุณุทุฑ ุฃูุงูุฑ Optimumุ ุนู ุทุฑูู ุชูุฑูุฑ ูุณูุท `--optimize {O1ุ O2ุ O3ุ O4}` ูู ูุงุฌูุฉ ุณุทุฑ ุงูุฃูุงูุฑุ ุนูู ุณุจูู ุงููุซุงู:

```
optimum-cli export onnx --model gpt2 --optimize O3 gpt2_onnx/
```

ูุณุชููุงุช ุงูุชุญุณูู ูู:

- O1: ุชุญุณููุงุช ุนุงูุฉ ุฃุณุงุณูุฉ.
- O2: ุชุญุณููุงุช ุนุงูุฉ ุฃุณุงุณูุฉ ูููุชุฏุฉุ ุนูููุงุช ุฏูุฌ ูุญููุงุช ูุญุฏุฏุฉ.
- O3: ููุณ O2 ูุน ุชูุฑูุจ GELU.
- O4: ููุณ O3 ูุน ุงูุฏูุฉ ุงููุฎุชูุทุฉ (fp16ุ GPU ููุทุ ูุชุทูุจ `--device cuda`).

## ุชุญุณูู ูููุฐุฌ ุจุฑูุฌูุงู ูุน `ORTOptimizer`

ูููู ุชุญุณูู ููุงุฐุฌ ONNX ุจุงุณุชุฎุฏุงู [`~ onnxruntime.ORTOptimizer`]. ูููู ุชููุฆุฉ ุงููุฆุฉ ุจุงุณุชุฎุฏุงู ุทุฑููุฉ [`~ onnxruntime.ORTOptimizer.from_pretrained`]ุ ูุงูุชู ุชุฏุนู ุชูุณููุงุช ููุงุท ุงูุชูุชูุด ุงููุฎุชููุฉ.

1. ุงุณุชุฎุฏุงู ูุฆุฉ [`~ onnxruntime.ORTModel`] ุงูุชู ุชู ุชููุฆุชูุง ุจุงููุนู.

```python
>>> from optimum.onnxruntime import ORTOptimizer, ORTModelForSequenceClassification

# ุชุญููู ูููุฐุฌ ONNX ูู ุงููุฑูุฒ
>>> model = ORTModelForSequenceClassification.from_pretrained(
...     "optimum/distilbert-base-uncased-finetuned-sst-2-english"
... )

# ุฅูุดุงุก ูุญุณู ูู ORTModelForXXX
>>> optimizer = ORTOptimizer.from_pretrained(model)
```

2. ุงุณุชุฎุฏุงู ูููุฐุฌ ONNX ูุญูู ูู ุฏููู.

```python
>>> from optimum.onnxruntime import ORTOptimizer

# ููุชุฑุถ ูุฐุง ูุฌูุฏ ูููุฐุฌ. onnx ูู path/to/model
>>> optimizer = ORTOptimizer.from_pretrained("path/to/model")  # doctest: +SKIP
```

### ุชูููู ุงูุชุญุณูู

ุชุณูุญ ูุฆุฉ [`~ onnxruntime.configuration.OptimizationConfig`] ุจุชุญุฏูุฏ ููููุฉ ุชูููุฐ ุงูุชุญุณูู ุจูุงุณุทุฉ [`~ onnxruntime.ORTOptimizer`].

ูู ุชูููู ุงูุชุญุณููุ ููุงู 4 ูุณุชููุงุช ุชุญุณูู ููููุฉ:

- `optimization_level=0`: ูุชุนุทูู ุฌููุน ุงูุชุญุณููุงุช
- `optimization_level=1`: ูุชูููู ุงูุชุญุณููุงุช ุงูุฃุณุงุณูุฉ ูุซู ุทู ุงูุซูุงุจุช ุฃู ุฅุฒุงูุฉ ุงูุนูุฏ ุงูุฒุงุฆุฏุฉ
- `optimization_level=2`: ูุชูููู ุงูุชุญุณููุงุช ุงูููุชุฏุฉ ููุฑุณู ุงูุจูุงูู ูุซู ุนูููุงุช ุฏูุฌ ุงูุนูุฏุฉ
- `optimization_level=99`: ูุชูููู ุชุญุณููุงุช ุชุฎุทูุท ุงูุจูุงูุงุช

ูุคุฏู ุงุฎุชูุงุฑ ูุณุชูู ุฅูู ุชูููู ุชุญุณููุงุช ูุฐุง ุงููุณุชููุ ุจุงูุฅุถุงูุฉ ุฅูู ุชุญุณููุงุช ุฌููุน ุงููุณุชููุงุช ุงูุณุงุจูุฉ.

ููุฒูุฏ ูู ุงููุนูููุงุชุ ุงููุฑ [ููุง](https://onnxruntime.ai/docs/performance/graph-optimizations.html).

`enable_transformers_specific_optimizations=True` ูุนูู ุฃูู ูุชู ุชูููุฐ ุฏูุฌ ุงูุฑุณู ุงูุจูุงูู ูุชูุฑูุจ ูุญููุงุช ูุญุฏุฏุฉ ุจุงูุฅุถุงูุฉ ุฅูู ุชุญุณููุงุช ONNX Runtime ุงูููุถุญุฉ ุฃุนูุงู.

ูููุง ููู ูุงุฆูุฉ ุจุงูุชุญุณููุงุช ุงูููููุฉ ุงูุชู ููููู ุชูููููุง:

- ุฏูุฌ Gelu ูุน `disable_gelu_fusion=False`ุ
- ุฏูุฌ ุงูุชุทุจูุน ุงูุทุจูู ูุน `disable_layer_norm_fusion=False`ุ
- ุฏูุฌ ุงูุงูุชูุงู ูุน `disable_attention_fusion=False`ุ
- ุชุฎุทู ุฏูุฌ ุงูุชุทุจูุน ุงูุทุจูู ูุน `disable_skip_layer_norm_fusion=False`ุ
- ุฅุถุงูุฉ ุชุญูุฒ ูุฏูุฌ ุงูุชุทุจูุน ุงูุทุจูู ูุน `disable_bias_skip_layer_norm_fusion=False`ุ
- ุฅุถุงูุฉ ุชุญูุฒ ูุฏูุฌ Gelu / FastGelu ูุน `disable_bias_gelu_fusion=False`ุ
- ุชูุฑูุจ Gelu ูุน `enable_gelu_approximation=True`.

<Tip>

ุชู ุชุตููู ุฏูุฌ ุงูุงูุชูุงู ููุชุฑููุฒ ูู ุงูุฌุงูุจ ุงูุฃููู ูุจููุงุช BERT-like (ูุซู BERTุ ูRoBERTaุ ูVITุ ููุง ุฅูู ุฐูู) ูููุชุฑููุฒ ูู ุงูุฌุงูุจ ุงูุฃูุณุฑ ููููุงุฐุฌ ุงูุชูููุฏูุฉ (GPT-like). ุฅุฐุง ููุช ูุง ุชุชุจุน ุงูุงุชูุงููุฉุ ูุฑุฌู ุชุนููู `use_raw_attention_mask=True` ูุชุฌูุจ ูุดููุงุช ุงูุฏูุฉ ุงููุญุชููุฉ ูููู ุงูุชุถุญูุฉ ุจุงูุฃุฏุงุก.

</Tip>

ูู ุญูู ุฃู [`~ onnxruntime.configuration.OptimizationConfig`] ูููุญู ุชุญูููุง ูุงููุงู ูู ููููุฉ ุฅุฌุฑุงุก ุงูุชุญุณููุ ููุฏ ูููู ูู ุงูุตุนุจ ูุนุฑูุฉ ูุง ูุฌุจ ุชููููู / ุชุนุทููู. ุจุฏูุงู ูู ุฐููุ ููููู ุงุณุชุฎุฏุงู [`~ onnxruntime.configuration.AutoOptimizationConfig`] ุงูุฐู ูููุฑ ุฃุฑุจุนุฉ ูุณุชููุงุช ุชุญุณูู ุดุงุฆุนุฉ:

- O1: ุชุญุณููุงุช ุนุงูุฉ ุฃุณุงุณูุฉ.
- O2: ุชุญุณููุงุช ุนุงูุฉ ุฃุณุงุณูุฉ ูููุชุฏุฉุ ุนูููุงุช ุฏูุฌ ูุญููุงุช ูุญุฏุฏุฉ.
- O3: ููุณ O2 ูุน ุชูุฑูุจ GELU.
- O4: ููุณ O3 ูุน ุงูุฏูุฉ ุงููุฎุชูุทุฉ (fp16ุ GPU ููุท).

ูุซุงู: ุชุญููู [`~ onnxruntime.configuration.OptimizationConfig`] O2

```python
>>> from optimum.onnxruntime import AutoOptimizationConfig
>>> optimization_config = AutoOptimizationConfig.O2()
```

ููููู ุฃูุถูุง ุชุญุฏูุฏ ูุณูุท ูุฎุตุต ูู ูุชู ุชุนุฑููู ูู ุชูููู O2ุ ุนูู ุณุจูู ุงููุซุงู:

```python
>>> from optimum.onnxruntime import AutoOptimizationConfig
>>> optimization_config = AutoOptimizationConfig.O2(disable_embed_layer_norm_fusion=False)
```

### ุฃูุซูุฉ ุนูู ุงูุชุญุณูู

ูููุง ููู ูุซุงู ุณูู ูู ุงูุจุฏุงูุฉ ุฅูู ุงูููุงูุฉ ุญูู ููููุฉ ุชุญุณูู [distilbert-base-uncased-finetuned-sst-2-english](https://huggingface.co/distilbert-base-uncased-finetuned-sst-2-english).

```python
>>> from optimum.onnxruntime import (
...     AutoOptimizationConfigุ ORTOptimizerุ ORTModelForSequenceClassification
... )

>>> model_id = "distilbert-base-uncased-finetuned-sst-2-english"
>>> save_dir = "distilbert_optimized"

>>> # ุชุญููู ูููุฐุฌ PyTorch ูุชุตุฏูุฑู ุฅูู ุชูุณูู ONNX
>>> model = ORTModelForSequenceClassification.from_pretrained(model_id, export=True)

>>> # ุฅูุดุงุก ุงููุญุณู
>>> optimizer = ORTOptimizer.from_pretrained(model)

>>> # ุชุญุฏูุฏ ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญุณูู ูู ุฎูุงู ุฅูุดุงุก ุงูุชูููู ุงูููุงุณุจ
>>> optimization_config = AutoOptimizationConfig.O2()

>>> # ุชุญุณูู ุงููููุฐุฌ
>>> optimizer.optimize(save_dir=save_dir,optimization_config=optimization_config)  # doctest: +IGNORE_RESULT
```

ูููุง ููู ูุซุงู ุณูู ูู ุงูุจุฏุงูุฉ ุฅูู ุงูููุงูุฉ ุญูู ููููุฉ ุชุญุณูู ูููุฐุฌ Seq2Seq [sshleifer/distilbart-cnn-12-6"](https://huggingface.co/sshleifer/distilbart-cnn-12-6).

```python
>>> from transformers import AutoTokenizer
>>> from optimum.onnxruntime import OptimizationConfig, ORTOptimizer, ORTModelForSeq2SeqLM

>>> model_id = "sshleifer/distilbart-cnn-12-6"
>>> save_dir = "distilbart_optimized"

>>> # ุชุญููู ูููุฐุฌ PyTorch ูุชุตุฏูุฑู ุฅูู ุชูุณูู ONNX
>>> model = ORTModelForSeq2SeqLM.from_pretrained(model_id, export=True)

>>> # ุฅูุดุงุก ุงููุญุณู
>>> optimizer = ORTOptimizer.from_pretrained(model)

>>> # ุชุญุฏูุฏ ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญุณูู ูู ุฎูุงู ุฅูุดุงุก ุงูุชูููู ุงูููุงุณุจ
>>> optimization_config = OptimizationConfig(
...     optimization_level=2,
...     enable_transformers_specific_optimizations=True,
...     optimize_for_gpu=False,
... )

>>> # ุชุญุณูู ุงููููุฐุฌ
>>> optimizer.optimize(save_dir=save_dirุ optimization_config=optimization_config)  # doctest: +IGNORE_RESULT

>>> tokenizer = AutoTokenizer.from_pretrained(model_id)
>>> optimized_model = ORTModelForSeq2SeqLM.from_pretrained(save_dir)
>>> tokens = tokenizer("This is a sample input", return_tensors="pt")
>>> outputs = optimized_model.generate(**tokens)
```

## ุชุญุณูู ูููุฐุฌ ูุน Optimum CLI

ูููู ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุชุญุณูู Optimum ONNX Runtime ูุจุงุดุฑุฉ ูู ุฎูุงู ูุงุฌูุฉ ุณุทุฑ ุงูุฃูุงูุฑ Optimum:

```bash
optimum-cli onnxruntime optimize --help
usage: optimum-cli <command> [<args>] onnxruntime optimize [-h] --onnx_model ONNX_MODEL -o OUTPUT (-O1 | -O2 | -O3 | -O4 | -c CONFIG)

options:
-hุ --help show this help message and exit
-O1 ุงูุชุญุณููุงุช ุงูุนุงูุฉ ุงูุฃุณุงุณูุฉ (ุฑุงุฌุน: https://huggingface.co/docs/optimum/onnxruntime/usage_guides/optimization ููุฒูุฏ ูู ุงูุชูุงุตูู).
-O2 ุชุญุณููุงุช ุนุงูุฉ ุฃุณุงุณูุฉ ูููุชุฏุฉุ ุนูููุงุช ุฏูุฌ ูุญููุงุช ูุญุฏุฏุฉ (ุฑุงุฌุน: https://huggingface.co/docs/optimum/onnxruntime/usage_guides/optimization ููุฒูุฏ ูู ุงูุชูุงุตูู).
-O3 ููุณ O2 ูุน ุชูุฑูุจ Gelu (ุฑุงุฌุน: https://huggingface.co/docs/optimum/onnxruntime/usage_guides/optimization ููุฒูุฏ ูู ุงูุชูุงุตูู).
-O4 ููุณ O3 ูุน ุงูุฏูุฉ ุงููุฎุชูุทุฉ (ุฑุงุฌุน: https://huggingface.co/docs/optimum/onnxruntime/usage_guides/optimization ููุฒูุฏ ูู ุงูุชูุงุตูู).
-c CONFIGุ --config CONFIG
ููู `ORTConfig` ุงููุณุชุฎุฏู ูุชุญุณูู ุงููููุฐุฌ.

ุงูุญุฌุฌ ุงููุทููุจุฉ:
--onnx_model ONNX_MODEL
ูุณุงุฑ ุฅูู ุงููุณุชูุฏุน ุญูุซ ุชูุฌุฏ ููุงุฐุฌ ONNX ุงูุชู ุณูุชู ุชุญุณูููุง.
-o OUTPUTุ --output OUTPUT
ูุณุงุฑ ุฅูู ุงูุฏููู ุงูุฐู ุณูุชู ููู ุชุฎุฒูู ูููุฐุฌ ONNX ุงููููุฏ.
```

ูููู ุชุญุณูู ูููุฐุฌ ONNX ุนูู ุงููุญู ุงูุชุงูู:

```bash
optimum-cli onnxruntime optimize --onnx_model onnx_model_location/ -O1 -o optimized_model/
```

ูุฐุง ูุญุณู ุฌููุน ูููุงุช ONNX ูู `onnx_model_location` ูุน ุงูุชุญุณููุงุช ุงูุนุงูุฉ ุงูุฃุณุงุณูุฉ.